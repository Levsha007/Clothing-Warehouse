{% extends "base.html" %}

{% block title %}–°–ü–ü–† - –û—Ü–µ–Ω–∫–∞ –∫–∞—á–µ—Å—Ç–≤–∞ –æ–¥–µ–∂–¥—ã{% endblock %}

{% block content %}
<div class="spzr-page">
    <h1 class="page-title">–°–∏—Å—Ç–µ–º–∞ –ø–æ–¥–¥–µ—Ä–∂–∫–∏ –ø—Ä–∏–Ω—è—Ç–∏—è —Ä–µ—à–µ–Ω–∏–π</h1>
    <p class="subtitle">–ü–æ—Ä–æ–≥–æ–≤—ã–π –º–µ—Ç–æ–¥ –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∏ –∫–∞—á–µ—Å—Ç–≤–∞ –ø—Ä–æ–¥—É–∫—Ü–∏–∏ (–í–∞—Ä–∏–∞–Ω—Ç 19 - –°–∫–ª–∞–¥ –æ–¥–µ–∂–¥—ã)</p>
    
    <div class="card" style="max-width: 600px; margin: 2rem auto;">
        <h3 style="margin-bottom: 1.5rem; color: var(--dark);">–ê–Ω–∞–ª–∏–∑ –ø—Ä–æ–¥—É–∫—Ü–∏–∏</h3>
        
        <form id="qualityForm" onsubmit="analyzeQuality(event)">
            <div class="form-group">
                <label>–ü–æ—Å—Ç–∞–≤—â–∏–∫</label>
                <select id="supplierSelect" class="form-control" required>
                    <option value="">-- –í—ã–±–µ—Ä–∏—Ç–µ –ø–æ—Å—Ç–∞–≤—â–∏–∫–∞ --</option>
                    {% for s in suppliers %}
                    <option value="{{ s.id }}">{{ s.name }}</option>
                    {% endfor %}
                </select>
            </div>
            
            <div class="form-group">
                <label>–ü—Ä–æ–¥—É–∫—Ü–∏—è</label>
                <select id="productSelect" class="form-control" required>
                    <option value="">-- –í—ã–±–µ—Ä–∏—Ç–µ –ø—Ä–æ–¥—É–∫—Ü–∏—é --</option>
                    {% for p in products %}
                    <option value="{{ p.id }}">{{ p.name }}</option>
                    {% endfor %}
                </select>
            </div>
            
            <div class="form-group">
                <label>–®–∞–≥ –∏–∑–º–µ—Ä–µ–Ω–∏—è Œîx (—á—É–≤—Å—Ç–≤–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å)</label>
                <input type="number" id="deltaX" class="form-control" value="1.0" step="0.1" min="0.1">
                <small>–ú–µ–Ω—å—à–µ –∑–Ω–∞—á–µ–Ω–∏–µ = –≤—ã—à–µ —á—É–≤—Å—Ç–≤–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å –∫ –æ—Ç–∫–ª–æ–Ω–µ–Ω–∏—è–º</small>
            </div>
            
            <div style="display: flex; gap: 1rem; margin-top: 2rem;">
                <button type="submit" class="btn btn-primary" style="flex: 1;">–û—Ü–µ–Ω–∏—Ç—å –∫–∞—á–µ—Å—Ç–≤–æ</button>
                <button type="button" class="btn" onclick="trainSystem()">–û–±—É—á–µ–Ω–∏–µ –°–ü–ü–†</button>
            </div>
        </form>
    </div>
    
    <div id="resultContainer" style="display: none;">
        <!-- –†–µ–∑—É–ª—å—Ç–∞—Ç—ã –ø–æ–¥–≥—Ä—É–∑—è—Ç—Å—è —á–µ—Ä–µ–∑ JS -->
    </div>
</div>

<script>
async function analyzeQuality(e) {
    e.preventDefault();
    
    const supplier = document.getElementById('supplierSelect').value;
    const product = document.getElementById('productSelect').value;
    const delta = document.getElementById('deltaX').value;
    
    if (!supplier || !product) {
        alert('–í—ã–±–µ—Ä–∏—Ç–µ –ø–æ—Å—Ç–∞–≤—â–∏–∫–∞ –∏ –ø—Ä–æ–¥—É–∫—Ü–∏—é');
        return;
    }
    
    const formData = new FormData();
    formData.append('supplier_id', supplier);
    formData.append('product_id', product);
    formData.append('delta_x', delta);
    
    const response = await fetch('/api/spzr/analyze', {
        method: 'POST',
        body: formData
    });
    
    const result = await response.json();
    
    if (result.success) {
        displayResults(result, supplier, product, delta);
    } else {
        alert('–û—à–∏–±–∫–∞: ' + result.error);
    }
}

function displayResults(data, supplierId, productId, delta) {
    const chars = data.characteristics;
    const metrics = data.metrics;
    
    let html = `
        <div class="card" style="margin-top: 2rem;">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem;">
                <h3>–†–µ–∑—É–ª—å—Ç–∞—Ç—ã –∞–Ω–∞–ª–∏–∑–∞</h3>
                <span style="background: ${metrics.is_quality ? '#5a7a6b' : '#b85c5c'}; color: white; padding: 0.5rem 1.2rem; border-radius: 40px; font-weight: 600;">
                    ${metrics.verdict}
                </span>
            </div>
            
            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1rem; margin-bottom: 2rem; background: var(--light); padding: 1.5rem; border-radius: 16px;">
                <div><strong>–°–∏–≥–Ω–∞–ª –Ω–æ—Ä–º—ã (Ch):</strong> ${metrics.Ch}</div>
                <div><strong>–°–∏–≥–Ω–∞–ª –æ—Ç–∫–ª–æ–Ω–µ–Ω–∏—è (Co):</strong> ${metrics.Co}</div>
                <div><strong>–û—Ç–Ω–æ—à–µ–Ω–∏–µ Go:</strong> ${metrics.Go}</div>
                <div><strong>–í–µ—Ä–æ—è—Ç–Ω–æ—Å—Ç—å P:</strong> ${metrics.P}</div>
                <div><strong>–®–∞–≥ Œîx:</strong> ${metrics.delta_x}</div>
            </div>
            
            <h4 style="margin-bottom: 1rem;">–î–µ—Ç–∞–ª–∏–∑–∞—Ü–∏—è –ø–æ —Ö–∞—Ä–∞–∫—Ç–µ—Ä–∏—Å—Ç–∏–∫–∞–º</h4>
            <div style="overflow-x: auto;">
                <table class="data-table">
                    <thead>
                        <tr>
                            <th>–•–∞—Ä–∞–∫—Ç–µ—Ä–∏—Å—Ç–∏–∫–∞</th>
                            <th>–ï–¥.</th>
                            <th>–ù–æ—Ä–º–∞ (min-max)</th>
                            <th>–†–µ–∞–ª—å–Ω–æ–µ</th>
                            <th>–ì—Ä–∞–¥–∞—Ü–∏–∏ n</th>
                            <th>log‚ÇÇ(n)</th>
                        </tr>
                    </thead>
                    <tbody>
    `;
    
    chars.forEach(c => {
        const isNorm = c.real >= c.min && c.real <= c.max;
        html += `<tr ${!isNorm ? 'style="background: #fff2f0;"' : ''}>
            <td><strong>${c.name}</strong></td>
            <td>${c.unit || '-'}</td>
            <td>${c.min} ‚Äì ${c.max}</td>
            <td style="font-weight: 600; ${!isNorm ? 'color: #b85c5c;' : ''}">${c.real}</td>
            <td>${c.gradations}</td>
            <td>${c.log2}</td>
        </tr>`;
    });
    
    html += `
                    </tbody>
                </table>
            </div>
            
            <div style="display: flex; gap: 1rem; margin-top: 2rem; justify-content: flex-end;">
                <a href="/spzr/report?supplier_id=${supplierId}&product_id=${productId}&delta_x=${delta}" 
                   class="btn btn-primary" target="_blank">
                    üìÑ –û—Ç–∫—Ä—ã—Ç—å –æ—Ç—á–µ—Ç
                </a>
                <button onclick="window.print()" class="btn">üñ®Ô∏è –ü–µ—á–∞—Ç—å</button>
            </div>
        </div>
    `;
    
    document.getElementById('resultContainer').innerHTML = html;
    document.getElementById('resultContainer').style.display = 'block';
}

async function trainSystem() {
    const supplier = document.getElementById('supplierSelect').value;
    const product = document.getElementById('productSelect').value;
    const delta = parseFloat(document.getElementById('deltaX').value);
    
    if (!supplier || !product) {
        alert('–í—ã–±–µ—Ä–∏—Ç–µ –ø–æ—Å—Ç–∞–≤—â–∏–∫–∞ –∏ –ø—Ä–æ–¥—É–∫—Ü–∏—é');
        return;
    }
    
    const targetQuality = confirm('–û–±—É—á–∏—Ç—å —Å–∏—Å—Ç–µ–º—É —Å—á–∏—Ç–∞—Ç—å –≠–¢–û–¢ –ø—Ä–æ–¥—É–∫—Ç –ö–ê–ß–ï–°–¢–í–ï–ù–ù–´–ú? (–ù–∞–∂–º–∏—Ç–µ –û–ö - –∫–∞—á–µ—Å—Ç–≤–µ–Ω–Ω—ã–π, –û—Ç–º–µ–Ω–∞ - –±—Ä–∞–∫)');
    
    const formData = new FormData();
    formData.append('supplier_id', supplier);
    formData.append('product_id', product);
    formData.append('target_quality', targetQuality);
    formData.append('current_delta', delta);
    
    const response = await fetch('/api/spzr/train', {
        method: 'POST',
        body: formData
    });
    
    const result = await response.json();
    
    if (result.success && result.found) {
        document.getElementById('deltaX').value = result.delta;
        alert(`‚úÖ –°–∏—Å—Ç–µ–º–∞ –æ–±—É—á–µ–Ω–∞! –ü–æ–¥–æ–±—Ä–∞–Ω —à–∞–≥ Œîx = ${result.delta}\n–í–µ—Ä–æ—è—Ç–Ω–æ—Å—Ç—å P = ${result.probability}`);
        analyzeQuality(new Event('submit'));
    } else {
        alert('‚ùå –ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–¥–æ–±—Ä–∞—Ç—å –ø–∞—Ä–∞–º–µ—Ç—Ä—ã. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –∏–∑–º–µ–Ω–∏—Ç—å Œîx –≤—Ä—É—á–Ω—É—é.');
    }
}
</script>

<style>
.spzr-page .subtitle {
    color: var(--dark);
    opacity: 0.7;
    margin-bottom: 2rem;
    font-size: 1.1rem;
}
.form-group {
    margin-bottom: 1.25rem;
}
.form-group label {
    display: block;
    margin-bottom: 0.5rem;
    font-weight: 500;
    color: var(--dark);
}
</style>
{% endblock %}