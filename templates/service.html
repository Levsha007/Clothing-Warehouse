{% extends "base.html" %}

{% block title %}–°–µ—Ä–≤–∏—Å - –°–∫–ª–∞–¥ –æ–¥–µ–∂–¥—ã{% endblock %}

{% block content %}
<div class="service-functions">
    <h1 class="page-title">üîß –°–µ—Ä–≤–∏—Å–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏</h1>
    
    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(340px, 1fr)); gap: 1.5rem;">
        <!-- –ë—ç–∫–∞–ø -->
        <div class="service-card" style="background: white; border-radius: 16px; padding: 1.5rem;">
            <h3 style="color: var(--dark); margin-bottom: 1rem;">üíæ –ü–æ–ª–Ω—ã–π –±—ç–∫–∞–ø</h3>
            <p style="color: var(--dark); opacity: 0.7; margin-bottom: 1rem;">
            –°–æ–∑–¥–∞–Ω–∏–µ —Ä–µ–∑–µ—Ä–≤–Ω–æ–π –∫–æ–ø–∏–∏ –≤—Å–µ–π –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö –≤ —Ñ–æ—Ä–º–∞—Ç–µ .backup
            </p>
            <div style="background: var(--light); padding: 0.8rem; border-radius: 8px; margin-bottom: 1.2rem;">
                <small>üìÅ –ü–∞–ø–∫–∞: backups/YYYYMMDD_HHMMSS/</small>
            </div>
            <button onclick="createBackup()" class="btn btn-primary" style="width: 100%;">
                üöÄ –°–æ–∑–¥–∞—Ç—å –±—ç–∫–∞–ø
            </button>
            <div id="backupResult" style="margin-top: 1rem;"></div>
        </div>
        
        <!-- –í–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ -->
        <div class="service-card" style="background: white; border-radius: 16px; padding: 1.5rem;">
            <h3 style="color: var(--dark); margin-bottom: 1rem;">üîÑ –í–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ</h3>
            <p style="color: var(--dark); opacity: 0.7; margin-bottom: 1rem;">
            –í–æ—Å—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –ë–î –∏–∑ .backup —Ñ–∞–π–ª–∞
            </p>
            <div style="background: #fff2f0; padding: 0.8rem; border-radius: 8px; margin-bottom: 1.2rem; border-left: 4px solid var(--danger);">
                <small style="color: var(--danger);">‚ö†Ô∏è –í—Å–µ —Ç–µ–∫—É—â–∏–µ –¥–∞–Ω–Ω—ã–µ –±—É–¥—É—Ç –∑–∞–º–µ–Ω–µ–Ω—ã!</small>
            </div>
            <div style="margin-bottom: 1rem;">
                <input type="file" id="backupFile" accept=".backup" class="form-control">
            </div>
            <button onclick="restoreBackup()" class="btn" style="width: 100%; background: var(--accent); color: var(--dark);">
                üìÇ –í–æ—Å—Å—Ç–∞–Ω–æ–≤–∏—Ç—å
            </button>
            <div id="restoreResult" style="margin-top: 1rem;"></div>
        </div>
        
        <!-- –ê—Ä—Ö–∏–≤–∞—Ü–∏—è —Ç–∞–±–ª–∏—Ü -->
        <div class="service-card" style="background: white; border-radius: 16px; padding: 1.5rem;">
            <h3 style="color: var(--dark); margin-bottom: 1rem;">üì¶ –ê—Ä—Ö–∏–≤–∞—Ü–∏—è —Ç–∞–±–ª–∏—Ü</h3>
            <p style="color: var(--dark); opacity: 0.7; margin-bottom: 1rem;">
            –ë—ç–∫–∞–ø + Excel + JSON + —É–¥–∞–ª–µ–Ω–∏–µ –∏–∑ –ë–î
            </p>
            <div style="background: #fff2e0; padding: 0.8rem; border-radius: 8px; margin-bottom: 1.2rem;">
                <small style="color: #b85c5c;">‚ö†Ô∏è –¢–∞–±–ª–∏—Ü—ã –±—É–¥—É—Ç —É–¥–∞–ª–µ–Ω—ã –ø–æ—Å–ª–µ –∞—Ä—Ö–∏–≤–∞—Ü–∏–∏!</small>
            </div>
            <div style="margin-bottom: 1rem;">
                <select id="archiveTables" multiple style="width: 100%; height: 120px; padding: 0.5rem; border-radius: 8px; border: 1px solid var(--border);">
                    {% for table in tables %}
                    <option value="{{ table }}">{{ table }}</option>
                    {% endfor %}
                </select>
                <small style="color: var(--dark); opacity: 0.6;">–£–¥–µ—Ä–∂–∏–≤–∞–π—Ç–µ Ctrl/Cmd –¥–ª—è –≤—ã–±–æ—Ä–∞ –Ω–µ—Å–∫–æ–ª—å–∫–∏—Ö</small>
            </div>
            <div style="display: flex; gap: 0.5rem; margin-bottom: 0.5rem;">
                <button onclick="archiveSelected()" class="btn btn-sm" style="background: var(--dark); color: white; flex: 1;">
                    üìå –í—ã–±—Ä–∞–Ω–Ω—ã–µ
                </button>
                <button onclick="archiveAll()" class="btn btn-sm" style="background: var(--danger); color: white; flex: 1;">
                    ‚ö†Ô∏è –í—Å–µ —Ç–∞–±–ª–∏—Ü—ã
                </button>
            </div>
            <div id="archiveResult" style="margin-top: 1rem;"></div>
        </div>
        
        <!-- –≠–∫—Å–ø–æ—Ä—Ç -->
        <div class="service-card" style="background: white; border-radius: 16px; padding: 1.5rem;">
            <h3 style="color: var(--dark); margin-bottom: 1rem;">üì§ –≠–∫—Å–ø–æ—Ä—Ç —Ç–∞–±–ª–∏—Ü</h3>
            <p style="color: var(--dark); opacity: 0.7; margin-bottom: 1rem;">
            –≠–∫—Å–ø–æ—Ä—Ç –±–µ–∑ —É–¥–∞–ª–µ–Ω–∏—è –∏–∑ –ë–î
            </p>
            <div style="margin-bottom: 1rem;">
                <select id="exportTables" multiple style="width: 100%; height: 100px; padding: 0.5rem; border-radius: 8px; border: 1px solid var(--border);">
                    {% for table in tables %}
                    <option value="{{ table }}">{{ table }}</option>
                    {% endfor %}
                </select>
            </div>
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 0.5rem; margin-bottom: 1rem;">
                <select id="exportFormat" style="padding: 0.5rem; border-radius: 8px; border: 1px solid var(--border);">
                    <option value="excel">Excel (.xlsx)</option>
                    <option value="json">JSON (.json)</option>
                </select>
                <button onclick="exportSelectedTables()" class="btn btn-success">
                    ‚¨áÔ∏è –≠–∫—Å–ø–æ—Ä—Ç
                </button>
            </div>
            <button onclick="exportAllTables()" class="btn btn-sm" style="width: 100%; background: var(--light);">
                üåê –≠–∫—Å–ø–æ—Ä—Ç –≤—Å–µ—Ö —Ç–∞–±–ª–∏—Ü
            </button>
        </div>
        
        <!-- –£–¥–∞–ª–µ–Ω–∏–µ —Ç–∞–±–ª–∏—Ü—ã -->
        <div class="service-card" style="background: white; border-radius: 16px; padding: 1.5rem;">
            <h3 style="color: var(--danger); margin-bottom: 1rem;">üóëÔ∏è –£–¥–∞–ª–µ–Ω–∏–µ —Ç–∞–±–ª–∏—Ü—ã</h3>
            <p style="color: var(--dark); opacity: 0.7; margin-bottom: 1rem;">
            –ü–æ–ª–Ω–æ–µ —É–¥–∞–ª–µ–Ω–∏–µ —Ç–∞–±–ª–∏—Ü—ã –∏–∑ –ë–î (–±–µ–∑–≤–æ–∑–≤—Ä–∞—Ç–Ω–æ)
            </p>
            <div style="background: #fee2e2; padding: 0.8rem; border-radius: 8px; margin-bottom: 1.2rem;">
                <small style="color: var(--danger);">‚ö†Ô∏è –≠—Ç–æ –¥–µ–π—Å—Ç–≤–∏–µ –Ω–µ–ª—å–∑—è –æ—Ç–º–µ–Ω–∏—Ç—å!</small>
            </div>
            <div style="margin-bottom: 1rem;">
                <select id="deleteTable" class="form-control">
                    <option value="">-- –í—ã–±–µ—Ä–∏—Ç–µ —Ç–∞–±–ª–∏—Ü—É --</option>
                    {% for table in tables %}
                    <option value="{{ table }}">{{ table }}</option>
                    {% endfor %}
                </select>
            </div>
            <button onclick="deleteTable()" class="btn btn-danger" style="width: 100%;">
                üî• –£–¥–∞–ª–∏—Ç—å —Ç–∞–±–ª–∏—Ü—É
            </button>
        </div>
    </div>
</div>

<script>
async function createBackup() {
    if (!confirm('–°–æ–∑–¥–∞—Ç—å –ø–æ–ª–Ω—ã–π –±—ç–∫–∞–ø –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö?')) return;
    
    const div = document.getElementById('backupResult');
    div.innerHTML = '<div class="loading" style="padding: 0.8rem;">‚è≥ –°–æ–∑–¥–∞–Ω–∏–µ –±—ç–∫–∞–ø–∞...</div>';
    
    const res = await fetch('/api/service/backup', {method: 'POST'});
    const result = await res.json();
    
    if (result.success) {
        div.innerHTML = `<div class="success" style="padding: 0.8rem;">‚úÖ ${result.message}</div>`;
    } else {
        div.innerHTML = `<div class="error" style="padding: 0.8rem;">‚ùå ${result.error}</div>`;
    }
}

async function restoreBackup() {
    const fileInput = document.getElementById('backupFile');
    if (!fileInput.files[0]) {
        alert('–í—ã–±–µ—Ä–∏—Ç–µ —Ñ–∞–π–ª .backup');
        return;
    }
    
    if (!confirm('‚ö†Ô∏è –í–ù–ò–ú–ê–ù–ò–ï! –í—Å–µ –¥–∞–Ω–Ω—ã–µ –±—É–¥—É—Ç –∑–∞–º–µ–Ω–µ–Ω—ã. –ü—Ä–æ–¥–æ–ª–∂–∏—Ç—å?')) return;
    
    const div = document.getElementById('restoreResult');
    div.innerHTML = '<div class="loading" style="padding: 0.8rem;">‚è≥ –í–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ...</div>';
    
    const formData = new FormData();
    formData.append('file', fileInput.files[0]);
    
    const res = await fetch('/api/service/restore', {
        method: 'POST',
        body: formData
    });
    
    const result = await res.json();
    
    if (result.success) {
        div.innerHTML = `<div class="success" style="padding: 0.8rem;">‚úÖ ${result.message}</div>`;
        setTimeout(() => location.reload(), 3000);
    } else {
        div.innerHTML = `<div class="error" style="padding: 0.8rem;">‚ùå ${result.error}</div>`;
    }
}

async function archiveSelected() {
    const select = document.getElementById('archiveTables');
    const tables = Array.from(select.selectedOptions).map(o => o.value);
    
    if (tables.length === 0) {
        alert('–í—ã–±–µ—Ä–∏—Ç–µ —Ç–∞–±–ª–∏—Ü—ã –¥–ª—è –∞—Ä—Ö–∏–≤–∞—Ü–∏–∏');
        return;
    }
    
    if (!confirm(`üì¶ –ê—Ä—Ö–∏–≤–∏—Ä–æ–≤–∞—Ç—å ${tables.length} —Ç–∞–±–ª–∏—Ü(—É)?\n\n‚ö†Ô∏è –¢–∞–±–ª–∏—Ü—ã –±—É–¥—É—Ç –£–î–ê–õ–ï–ù–´ –∏–∑ –ë–î!`)) return;
    
    const div = document.getElementById('archiveResult');
    div.innerHTML = '<div class="loading" style="padding: 0.8rem;">‚è≥ –ê—Ä—Ö–∏–≤–∏—Ä–æ–≤–∞–Ω–∏–µ...</div>';
    
    const formData = new FormData();
    formData.append('tables', JSON.stringify(tables));
    formData.append('archive_all', 'false');
    
    const res = await fetch('/api/service/archive', {
        method: 'POST',
        body: formData
    });
    
    const result = await res.json();
    
    if (result.success) {
        div.innerHTML = `<div class="success" style="padding: 0.8rem;">
            ‚úÖ ${result.message}<br>
            üìÅ –ü–∞–ø–∫–∞: ${result.archive_dir}
        </div>`;
        setTimeout(() => location.reload(), 3000);
    } else {
        div.innerHTML = `<div class="error" style="padding: 0.8rem;">‚ùå ${result.error}</div>`;
    }
}

async function archiveAll() {
    if (!confirm('‚ö†Ô∏è –ê–†–•–ò–í–ê–¶–ò–Ø –í–°–ï–• –¢–ê–ë–õ–ò–¶!\n\n–í—Å–µ —Ç–∞–±–ª–∏—Ü—ã –±—É–¥—É—Ç —É–¥–∞–ª–µ–Ω—ã –∏–∑ –ë–î.\n–ü—Ä–æ–¥–æ–ª–∂–∏—Ç—å?')) return;
    
    const div = document.getElementById('archiveResult');
    div.innerHTML = '<div class="loading" style="padding: 0.8rem;">‚è≥ –ê—Ä—Ö–∏–≤–∏—Ä–æ–≤–∞–Ω–∏–µ –≤—Å–µ—Ö —Ç–∞–±–ª–∏—Ü...</div>';
    
    const formData = new FormData();
    formData.append('tables', '[]');
    formData.append('archive_all', 'true');
    
    const res = await fetch('/api/service/archive', {
        method: 'POST',
        body: formData
    });
    
    const result = await res.json();
    
    if (result.success) {
        div.innerHTML = `<div class="success" style="padding: 0.8rem;">
            ‚úÖ ${result.message}<br>
            üìÅ –ü–∞–ø–∫–∞: ${result.archive_dir}
        </div>`;
        setTimeout(() => location.reload(), 3000);
    } else {
        div.innerHTML = `<div class="error" style="padding: 0.8rem;">‚ùå ${result.error}</div>`;
    }
}

async function exportSelectedTables() {
    const select = document.getElementById('exportTables');
    const tables = Array.from(select.selectedOptions).map(o => o.value);
    const format = document.getElementById('exportFormat').value;
    
    if (tables.length === 0) {
        alert('–í—ã–±–µ—Ä–∏—Ç–µ —Ç–∞–±–ª–∏—Ü—ã –¥–ª—è —ç–∫—Å–ø–æ—Ä—Ç–∞');
        return;
    }
    
    const formData = new FormData();
    tables.forEach(t => formData.append('tables', t));
    formData.append('format', format);
    
    const res = await fetch('/api/export/tables', {
        method: 'POST',
        body: formData
    });
    
    if (res.ok) {
        const blob = await res.blob();
        const url = window.URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = `export_${Date.now()}.${format === 'excel' ? 'xlsx' : 'json'}`;
        a.click();
        window.URL.revokeObjectURL(url);
    } else {
        const err = await res.json();
        alert('‚ùå ' + err.error);
    }
}

function exportAllTables() {
    const format = document.getElementById('exportFormat').value;
    window.open(`/api/export/all/${format}`, '_blank');
}

async function deleteTable() {
    const select = document.getElementById('deleteTable');
    const table = select.value;
    
    if (!table) {
        alert('–í—ã–±–µ—Ä–∏—Ç–µ —Ç–∞–±–ª–∏—Ü—É');
        return;
    }
    
    if (!confirm(`üî• –£–î–ê–õ–ò–¢–¨ –¢–ê–ë–õ–ò–¶–£ "${table}"?\n\n–≠—Ç–æ –¥–µ–π—Å—Ç–≤–∏–µ –Ω–µ–æ–±—Ä–∞—Ç–∏–º–æ!`)) return;
    
    const formData = new FormData();
    formData.append('table', table);
    
    const res = await fetch('/api/table/delete', {
        method: 'POST',
        body: formData
    });
    
    const result = await res.json();
    
    if (result.success) {
        alert('‚úÖ ' + result.message);
        location.reload();
    } else {
        alert('‚ùå ' + result.error);
    }
}
</script>
{% endblock %}