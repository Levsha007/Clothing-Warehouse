{% extends "base.html" %}

{% block title %}–°–ü–ü–† - –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π –∞–Ω–∞–ª–∏–∑ –∫–∞—á–µ—Å—Ç–≤–∞{% endblock %}

{% block content %}
<div class="spzr-dashboard">
    <h1 class="page-title">üìä –°–∏—Å—Ç–µ–º–∞ –ø–æ–¥–¥–µ—Ä–∂–∫–∏ –ø—Ä–∏–Ω—è—Ç–∏—è —Ä–µ—à–µ–Ω–∏–π</h1>
    <p class="subtitle" style="color: var(--deep-ink); opacity: 0.7; margin-bottom: 1rem; font-size: 1.1rem;">
        –ü–æ—Ä–æ–≥–æ–≤—ã–π –º–µ—Ç–æ–¥ –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∏ –∫–∞—á–µ—Å—Ç–≤–∞ –ø—Ä–æ–¥—É–∫—Ü–∏–∏ (–ø–æ –º–µ—Ç–æ–¥–∏—á–∫–µ, —Å—Ç—Ä. 33-38)
    </p>
    
    <!-- –ü–æ—è—Å–Ω–µ–Ω–∏–µ -->
    <div style="background: var(--bone); border-radius: 12px; padding: 1.5rem; margin-bottom: 2rem; border-left: 4px solid var(--sand);">
        <h4 style="color: var(--deep-ink); margin-bottom: 0.75rem;">üìê –§–æ—Ä–º—É–ª—ã —Ä–∞—Å—á–µ—Ç–∞:</h4>
        <ul style="list-style: none; padding: 0; display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1rem;">
            <li><strong>Ch = N</strong> ‚Äî —Å–∏–≥–Ω–∞–ª –Ω–æ—Ä–º—ã (–∫–æ–ª–∏—á–µ—Å—Ç–≤–æ —Ö–∞—Ä–∞–∫—Ç–µ—Ä–∏—Å—Ç–∏–∫)</li>
            <li><strong>Co = Œ£ log‚ÇÇ(n·µ¢)</strong> ‚Äî —Å–∏–≥–Ω–∞–ª –æ—Ç–∫–ª–æ–Ω–µ–Ω–∏—è</li>
            <li><strong>Go = Co / Ch</strong> ‚Äî –æ—Ç–Ω–æ—à–µ–Ω–∏–µ –æ—Ç–∫–ª–æ–Ω–µ–Ω–∏–µ/–Ω–æ—Ä–º–∞</li>
            <li><strong>P = exp(-Go¬≤/2)</strong> ‚Äî –≤–µ—Ä–æ—è—Ç–Ω–æ—Å—Ç—å –ø—Ä–∞–≤–∏–ª—å–Ω–æ–π –∫–ª–∞—Å—Å–∏—Ñ–∏–∫–∞—Ü–∏–∏</li>
        </ul>
        <p style="margin-top: 1rem; padding-top: 1rem; border-top: 1px solid var(--border);">
            <strong>‚úÖ –ü—Ä–∞–≤–∏–ª–æ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏—è:</strong> <span style="background: var(--success); color: white; padding: 0.2rem 0.8rem; border-radius: 20px;">P ‚â§ 0.5 ‚Üí –ö–ê–ß–ï–°–¢–í–ï–ù–ù–´–ô</span> 
            <span style="margin-left: 1rem; background: var(--danger); color: white; padding: 0.2rem 0.8rem; border-radius: 20px;">P > 0.5 ‚Üí –ë–†–ê–ö</span>
            <br>
            <small style="opacity: 0.7;">(–∏–∑ –º–µ—Ç–æ–¥–∏—á–∫–∏: "–ó–∞ –¥–∏–∞–ø–∞–∑–æ–Ω –Ω–æ—Ä–º—ã –ø—Ä–∏–Ω–∏–º–∞–µ—Ç—Å—è –∑–Ω–∞—á–µ–Ω–∏–µ –≤–µ—Ä–æ—è—Ç–Ω–æ—Å—Ç–∏ P –æ—Ç 0 –¥–æ 0,5")</small>
        </p>
    </div>
    
    <!-- –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ -->
    <div class="stats-grid" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1.5rem; margin-bottom: 2rem;">
        <div class="stat-card" style="background: white; border-radius: 16px; padding: 1.5rem; text-align: center;">
            <div style="font-size: 0.9rem; opacity: 0.7;">–í—Å–µ–≥–æ –ø–æ–∑–∏—Ü–∏–π</div>
            <div id="totalCount" class="stat-number" style="font-size: 2.5rem; font-weight: 700; color: var(--deep-ink);">0</div>
        </div>
        <div class="stat-card" style="background: white; border-radius: 16px; padding: 1.5rem; text-align: center;">
            <div style="font-size: 0.9rem; opacity: 0.7;">–ö–∞—á–µ—Å—Ç–≤–µ–Ω–Ω—ã–µ (P ‚â§ 0.5)</div>
            <div id="qualityCount" class="stat-number" style="font-size: 2.5rem; font-weight: 700; color: var(--success);">0</div>
        </div>
        <div class="stat-card" style="background: white; border-radius: 16px; padding: 1.5rem; text-align: center;">
            <div style="font-size: 0.9rem; opacity: 0.7;">–ë—Ä–∞–∫ (P > 0.5)</div>
            <div id="defectCount" class="stat-number" style="font-size: 2.5rem; font-weight: 700; color: var(--danger);">0</div>
        </div>
        <div class="stat-card" style="background: white; border-radius: 16px; padding: 1.5rem; text-align: center;">
            <div style="font-size: 0.9rem; opacity: 0.7;">–°—Ä–µ–¥–Ω–∏–π Co/Ch</div>
            <div id="avgGo" class="stat-number" style="font-size: 2.5rem; font-weight: 700; color: var(--clay);">0</div>
        </div>
    </div>
    
    <!-- –ü–∞–Ω–µ–ª—å —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è -->
    <div style="display: flex; gap: 1rem; margin-bottom: 2rem; flex-wrap: wrap; justify-content: space-between; align-items: center;">
        <div style="display: flex; gap: 1rem;">
            <button onclick="loadAnalysis()" class="btn btn-primary">
                üîÑ –û–±–Ω–æ–≤–∏—Ç—å –∞–Ω–∞–ª–∏–∑
            </button>
            <button onclick="trainSystem()" class="btn" style="background: var(--sand); color: var(--deep-ink);">
                üß† –ü–æ–¥–æ–±—Ä–∞—Ç—å –æ–ø—Ç–∏–º–∞–ª—å–Ω—ã–π Œîx
            </button>
        </div>
        <div style="display: flex; gap: 1rem;">
            <select id="filterSelect" class="form-control" style="width: 150px;" onchange="filterResults()">
                <option value="all">–í—Å–µ –ø–æ–∑–∏—Ü–∏–∏</option>
                <option value="quality">–¢–æ–ª—å–∫–æ –∫–∞—á–µ—Å—Ç–≤–µ–Ω–Ω—ã–µ</option>
                <option value="defect">–¢–æ–ª—å–∫–æ –±—Ä–∞–∫</option>
            </select>
            <input type="text" id="searchInput" class="form-control" placeholder="üîç –ü–æ–∏—Å–∫..." style="width: 250px;" onkeyup="filterResults()">
        </div>
    </div>
    
    <!-- –ò–Ω–¥–∏–∫–∞—Ç–æ—Ä –∑–∞–≥—Ä—É–∑–∫–∏ -->
    <div id="loadingIndicator" style="display: none; text-align: center; padding: 3rem;">
        <div class="loading" style="display: inline-block; padding: 1rem 2rem; border-radius: 40px;">
            ‚è≥ –ê–Ω–∞–ª–∏–∑ –¥–∞–Ω–Ω—ã—Ö...
        </div>
    </div>
    
    <!-- –†–µ–∑—É–ª—å—Ç–∞—Ç—ã –∞–Ω–∞–ª–∏–∑–∞ -->
    <div id="resultsContainer" style="display: none;">
        <div class="spzr-results-table" style="background: white; border-radius: 16px; padding: 1.5rem; border: 1px solid var(--border);">
            <h3 style="color: var(--deep-ink); margin-bottom: 1.5rem;">üìã –†–µ–∑—É–ª—å—Ç–∞—Ç—ã –ø–æ—Ä–æ–≥–æ–≤–æ–π –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∏</h3>
            
            <div style="overflow-x: auto;">
                <table class="data-table" id="resultsTable">
                    <thead>
                        <tr>
                            <th>–ü–æ—Å—Ç–∞–≤—â–∏–∫</th>
                            <th>–ü—Ä–æ–¥—É–∫—Ü–∏—è</th>
                            <th>N (Ch)</th>
                            <th title="–°—É–º–º–∞ log‚ÇÇ(n)">Co</th>
                            <th title="–û—Ç–Ω–æ—à–µ–Ω–∏–µ Co/Ch">Go</th>
                            <th title="–í–µ—Ä–æ—è—Ç–Ω–æ—Å—Ç—å P = exp(-Go¬≤/2)">P</th>
                            <th>–í–µ—Ä–¥–∏–∫—Ç</th>
                            <th>–î–µ–π—Å—Ç–≤–∏—è</th>
                        </tr>
                    </thead>
                    <tbody id="tableBody">
                        <!-- –î–∞–Ω–Ω—ã–µ –ø–æ–¥–≥—Ä—É–∑—è—Ç—Å—è —á–µ—Ä–µ–∑ JS -->
                    </tbody>
                </table>
            </div>
            
            <!-- –°–Ω–æ—Å–∫–∞ -->
            <div style="margin-top: 1.5rem; padding-top: 1rem; border-top: 1px solid var(--border); font-size: 0.9rem; color: var(--deep-ink); opacity: 0.7;">
                <p>üìå <strong>–ü–æ—è—Å–Ω–µ–Ω–∏—è:</strong></p>
                <ul style="margin-left: 1.5rem;">
                    <li><strong>Ch (—Å–∏–≥–Ω–∞–ª –Ω–æ—Ä–º—ã)</strong> = –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ —Ö–∞—Ä–∞–∫—Ç–µ—Ä–∏—Å—Ç–∏–∫ (N)</li>
                    <li><strong>Co (—Å–∏–≥–Ω–∞–ª –æ—Ç–∫–ª–æ–Ω–µ–Ω–∏—è)</strong> = —Å—É–º–º–∞ –¥–≤–æ–∏—á–Ω—ã—Ö –ª–æ–≥–∞—Ä–∏—Ñ–º–æ–≤ –≥—Ä–∞–¥–∞—Ü–∏–π: Co = Œ£ log‚ÇÇ(n·µ¢)</li>
                    <li><strong>Go (–æ—Ç–Ω–æ—à–µ–Ω–∏–µ)</strong> = Co / Ch ‚Äî —á–µ–º –±–æ–ª—å—à–µ Go, —Ç–µ–º —Å–∏–ª—å–Ω–µ–µ –æ—Ç–∫–ª–æ–Ω–µ–Ω–∏–µ –æ—Ç –Ω–æ—Ä–º—ã</li>
                    <li><strong>P (–≤–µ—Ä–æ—è—Ç–Ω–æ—Å—Ç—å)</strong> = exp(-Go¬≤/2) ‚Äî —á–µ–º –º–µ–Ω—å—à–µ P, —Ç–µ–º –Ω–∞–¥–µ–∂–Ω–µ–µ –∫–ª–∞—Å—Å–∏—Ñ–∏–∫–∞—Ü–∏—è</li>
                    <li><strong>‚úÖ –ö–∞—á–µ—Å—Ç–≤–µ–Ω–Ω—ã–π:</strong> P ‚â§ 0.5 | <strong>‚ùå –ë—Ä–∞–∫:</strong> P > 0.5 (–ø–æ –º–µ—Ç–æ–¥–∏—á–∫–µ —Å—Ç—Ä. 38)</li>
                </ul>
            </div>
        </div>
    </div>
    
    <!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ —Å –¥–µ—Ç–∞–ª—è–º–∏ -->
    <div id="detailModal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 1000; justify-content: center; align-items: center;">
        <div style="background: white; border-radius: 16px; padding: 2rem; max-width: 900px; width: 90%; max-height: 80vh; overflow-y: auto;">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem;">
                <h3 style="color: var(--deep-ink);">–î–µ—Ç–∞–ª—å–Ω—ã–π –∞–Ω–∞–ª–∏–∑</h3>
                <button onclick="closeModal()" style="background: none; border: none; font-size: 1.5rem; cursor: pointer;">‚úï</button>
            </div>
            <div id="modalContent">
                <!-- –°–æ–¥–µ—Ä–∂–∏–º–æ–µ –ø–æ–¥–≥—Ä—É–∑–∏—Ç—Å—è -->
            </div>
        </div>
    </div>
</div>

<script>
let allResults = [];
let currentDelta = 1.0; // –¢–µ–∫—É—â–∏–π —à–∞–≥ Œîx

// –ó–∞–≥—Ä—É–∑–∫–∞ –ø—Ä–∏ –æ—Ç–∫—Ä—ã—Ç–∏–∏ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
document.addEventListener('DOMContentLoaded', function() {
    loadAnalysis();
});

async function loadAnalysis() {
    document.getElementById('loadingIndicator').style.display = 'block';
    document.getElementById('resultsContainer').style.display = 'none';
    
    try {
        const response = await fetch('/api/spzr/analyze-all');
        const data = await response.json();
        
        if (data.success) {
            allResults = data.results;
            
            // –û–±–Ω–æ–≤–ª—è–µ–º —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É
            document.getElementById('totalCount').textContent = data.total;
            document.getElementById('qualityCount').textContent = data.quality;
            document.getElementById('defectCount').textContent = data.defect;
            
            // –°—Ä–µ–¥–Ω–∏–π Go
            const avgGo = data.results.reduce((sum, r) => sum + r.metrics.Go, 0) / data.total;
            document.getElementById('avgGo').textContent = avgGo.toFixed(3);
            
            // –û—Ç–æ–±—Ä–∞–∂–∞–µ–º —Ç–∞–±–ª–∏—Ü—É
            renderTable(allResults);
            document.getElementById('resultsContainer').style.display = 'block';
        } else {
            alert('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏: ' + data.error);
        }
    } catch (e) {
        alert('–û—à–∏–±–∫–∞: ' + e.message);
    } finally {
        document.getElementById('loadingIndicator').style.display = 'none';
    }
}

function renderTable(results) {
    const tbody = document.getElementById('tableBody');
    tbody.innerHTML = '';
    
    if (!results || results.length === 0) {
        tbody.innerHTML = '<tr><td colspan="8" style="text-align: center; padding: 2rem;">–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö</td></tr>';
        return;
    }
    
    results.forEach(item => {
        const metrics = item.metrics;
        const isQuality = metrics.P <= 0.5; // –ü–æ –º–µ—Ç–æ–¥–∏—á–∫–µ: P ‚â§ 0.5 ‚Üí –∫–∞—á–µ—Å—Ç–≤–µ–Ω–Ω—ã–π
        
        const row = document.createElement('tr');
        row.innerHTML = `
            <td><strong>${item.supplier_name}</strong></td>
            <td>${item.product_name}</td>
            <td>${metrics.Ch}</td>
            <td>${metrics.Co.toFixed(3)}</td>
            <td>${metrics.Go.toFixed(3)}</td>
            <td>${metrics.P.toFixed(4)}</td>
            <td>
                <span style="display: inline-block; padding: 0.3rem 0.8rem; border-radius: 20px; background: ${isQuality ? 'var(--success)' : 'var(--danger)'}; color: white; font-size: 0.8rem;">
                    ${isQuality ? '‚úì –ö–ê–ß–ï–°–¢–í–ï–ù–ù–´–ô' : '‚úó –ë–†–ê–ö'}
                </span>
            </td>
            <td>
                <button onclick="showDetails(${item.product_id}, ${item.supplier_id})" class="btn btn-sm" style="background: var(--sand); color: var(--deep-ink);">
                    –î–µ—Ç–∞–ª–∏
                </button>
            </td>
        `;
        
        // –î–æ–±–∞–≤–ª—è–µ–º –∫–ª–∞—Å—Å –¥–ª—è –ø–æ–¥—Å–≤–µ—Ç–∫–∏
        if (isQuality) {
            row.classList.add('quality-row');
        } else {
            row.classList.add('defect-row');
        }
        
        tbody.appendChild(row);
    });
}

function filterResults() {
    const filter = document.getElementById('filterSelect').value;
    const search = document.getElementById('searchInput').value.toLowerCase();
    
    let filtered = allResults;
    
    // –§–∏–ª—å—Ç—Ä –ø–æ –∫–∞—á–µ—Å—Ç–≤—É
    if (filter === 'quality') {
        filtered = filtered.filter(r => r.metrics.P <= 0.5);
    } else if (filter === 'defect') {
        filtered = filtered.filter(r => r.metrics.P > 0.5);
    }
    
    // –ü–æ–∏—Å–∫ –ø–æ —Ç–µ–∫—Å—Ç—É
    if (search) {
        filtered = filtered.filter(r => 
            r.supplier_name.toLowerCase().includes(search) ||
            r.product_name.toLowerCase().includes(search)
        );
    }
    
    renderTable(filtered);
}

async function showDetails(productId, supplierId) {
    try {
        const response = await fetch(`/api/spzr/product-detail?product_id=${productId}&supplier_id=${supplierId}`);
        const data = await response.json();
        
        if (data.success) {
            displayModal(data);
        } else {
            alert('–û—à–∏–±–∫–∞: ' + data.error);
        }
    } catch (e) {
        alert('–û—à–∏–±–∫–∞: ' + e.message);
    }
}

function displayModal(data) {
    const product = data.product;
    const chars = data.characteristics;
    const metrics = data.metrics;
    const isQuality = metrics.P <= 0.5;
    
    let charsHtml = '';
    chars.forEach(c => {
        const inNorm = c.in_norm;
        charsHtml += `
            <tr ${!inNorm ? 'style="background: #FFF5F5;"' : ''}>
                <td><strong>${c.name}</strong></td>
                <td>${c.unit || '-'}</td>
                <td>${c.min} ‚Äî ${c.max}</td>
                <td style="font-weight: 600; ${!inNorm ? 'color: var(--danger);' : ''}">${c.real}</td>
                <td>${c.gradations}</td>
                <td>${c.log2.toFixed(3)}</td>
                <td>${c.weight}</td>
                <td>${inNorm ? '‚úì –≤ –Ω–æ—Ä–º–µ' : '‚úó –æ—Ç–∫–ª–æ–Ω–µ–Ω–∏–µ'}</td>
            </tr>
        `;
    });
    
    // –†–∞—Å—á–µ—Ç –≤–∫–ª–∞–¥–∞ –∫–∞–∂–¥–æ–π —Ö–∞—Ä–∞–∫—Ç–µ—Ä–∏—Å—Ç–∏–∫–∏ –≤ Co
    const log2Sum = chars.reduce((sum, c) => sum + c.log2, 0).toFixed(3);
    
    const modalContent = document.getElementById('modalContent');
    modalContent.innerHTML = `
        <div style="margin-bottom: 2rem;">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
                <h4 style="color: var(--deep-ink);">${product.product_name}</h4>
                <span style="padding: 0.5rem 1.2rem; border-radius: 40px; background: ${isQuality ? 'var(--success)' : 'var(--danger)'}; color: white; font-weight: 600;">
                    ${isQuality ? '‚úì –ö–ê–ß–ï–°–¢–í–ï–ù–ù–´–ô' : '‚úó –ë–†–ê–ö'}
                </span>
            </div>
            <p><strong>–ü–æ—Å—Ç–∞–≤—â–∏–∫:</strong> ${product.supplier_name}</p>
            <p><strong>–ö–∞—Ç–µ–≥–æ—Ä–∏—è:</strong> ${product.category || '‚Äî'}</p>
            <p><strong>–û–ø–∏—Å–∞–Ω–∏–µ:</strong> ${product.description || '‚Äî'}</p>
        </div>
        
        <div style="background: var(--bone); padding: 1.5rem; border-radius: 12px; margin-bottom: 2rem;">
            <h4 style="margin-bottom: 1rem;">–†–∞—Å—á–µ—Ç –ø–æ–∫–∞–∑–∞—Ç–µ–ª–µ–π:</h4>
            <table style="width: 100%;">
                <tr>
                    <td><strong>Ch = N</strong> = ${metrics.Ch}</td>
                    <td><strong>Co = Œ£ log‚ÇÇ(n·µ¢)</strong> = ${log2Sum}</td>
                </tr>
                <tr>
                    <td><strong>Go = Co / Ch</strong> = ${log2Sum} / ${metrics.Ch} = ${metrics.Go.toFixed(3)}</td>
                    <td><strong>P = exp(-Go¬≤/2)</strong> = exp(-${(metrics.Go**2).toFixed(3)}/2) = ${metrics.P.toFixed(4)}</td>
                </tr>
            </table>
        </div>
        
        <h4 style="margin-bottom: 1rem;">–î–µ—Ç–∞–ª–∏–∑–∞—Ü–∏—è —Ö–∞—Ä–∞–∫—Ç–µ—Ä–∏—Å—Ç–∏–∫</h4>
        <div style="overflow-x: auto;">
            <table class="data-table">
                <thead>
                    <tr>
                        <th>–•–∞—Ä–∞–∫—Ç–µ—Ä–∏—Å—Ç–∏–∫–∞</th>
                        <th>–ï–¥.</th>
                        <th>–ù–æ—Ä–º–∞</th>
                        <th>–†–µ–∞–ª—å–Ω–æ–µ</th>
                        <th>n</th>
                        <th>log‚ÇÇ(n)</th>
                        <th>–í–µ—Å</th>
                        <th>–°—Ç–∞—Ç—É—Å</th>
                    </tr>
                </thead>
                <tbody>
                    ${charsHtml}
                </tbody>
            </table>
        </div>
        
        <div style="margin-top: 1.5rem; padding: 1rem; background: #f0f7ff; border-radius: 8px;">
            <p><strong>–§–æ—Ä–º—É–ª—ã –∏–∑ –º–µ—Ç–æ–¥–∏—á–∫–∏:</strong></p>
            <ul style="margin-left: 1.5rem;">
                <li>–ì—Ä–∞–¥–∞—Ü–∏–∏: –µ—Å–ª–∏ –≤ –Ω–æ—Ä–º–µ ‚Üí n=2; –µ—Å–ª–∏ –≤—ã—à–µ: n = (x - xmin)/Œîx + 1; –µ—Å–ª–∏ –Ω–∏–∂–µ: n = (xmax - x)/Œîx + 1</li>
                <li>–°–∏–≥–Ω–∞–ª –Ω–æ—Ä–º—ã: Ch = N = ${metrics.Ch}</li>
                <li>–°–∏–≥–Ω–∞–ª –æ—Ç–∫–ª–æ–Ω–µ–Ω–∏—è: Co = Œ£ log‚ÇÇ(n·µ¢) = ${log2Sum}</li>
                <li>–û—Ç–Ω–æ—à–µ–Ω–∏–µ: Go = Co/Ch = ${metrics.Go.toFixed(3)}</li>
                <li>–í–µ—Ä–æ—è—Ç–Ω–æ—Å—Ç—å: P = exp(-Go¬≤/2) = ${metrics.P.toFixed(4)}</li>
                <li><strong>–ü—Ä–∞–≤–∏–ª–æ: P ‚â§ 0.5 ‚Üí –∫–∞—á–µ—Å—Ç–≤–µ–Ω–Ω—ã–π (–ø–æ –º–µ—Ç–æ–¥–∏—á–∫–µ —Å—Ç—Ä. 38)</strong></li>
            </ul>
        </div>
    `;
    
    document.getElementById('detailModal').style.display = 'flex';
}

function closeModal() {
    document.getElementById('detailModal').style.display = 'none';
}

async function trainSystem() {
    if (!confirm('–ü–æ–¥–æ–±—Ä–∞—Ç—å –æ–ø—Ç–∏–º–∞–ª—å–Ω—ã–π —à–∞–≥ Œîx –¥–ª—è –≤—Å–µ–π –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö?\n\n–≠—Ç–æ –º–æ–∂–µ—Ç –∑–∞–Ω—è—Ç—å –Ω–µ—Å–∫–æ–ª—å–∫–æ —Å–µ–∫—É–Ω–¥.')) {
        return;
    }
    
    const btn = event.target;
    const originalText = btn.textContent;
    btn.textContent = '‚è≥ –ü–æ–¥–±–æ—Ä Œîx...';
    btn.disabled = true;
    
    try {
        const response = await fetch('/api/spzr/train-all', {
            method: 'POST'
        });
        const data = await response.json();
        
        if (data.success) {
            alert(`‚úÖ –û–±—É—á–µ–Ω–∏–µ –∑–∞–≤–µ—Ä—à–µ–Ω–æ!\n\n–û–ø—Ç–∏–º–∞–ª—å–Ω—ã–π —à–∞–≥ Œîx = ${data.best_delta}\n\n–ß—Ç–æ —ç—Ç–æ –∑–Ω–∞—á–∏—Ç?\n–ß–µ–º –º–µ–Ω—å—à–µ Œîx, —Ç–µ–º —á—É–≤—Å—Ç–≤–∏—Ç–µ–ª—å–Ω–µ–µ —Å–∏—Å—Ç–µ–º–∞ –∫ –æ—Ç–∫–ª–æ–Ω–µ–Ω–∏—è–º.\n–†–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å Œîx = ${data.best_delta} –¥–ª—è –≤—Å–µ—Ö —Ä–∞—Å—á–µ—Ç–æ–≤.`);
            
            // –ü–µ—Ä–µ–∑–∞–≥—Ä—É–∂–∞–µ–º –∞–Ω–∞–ª–∏–∑ —Å –Ω–æ–≤—ã–º Œîx
            // –í —Ä–µ–∞–ª—å–Ω–æ–º –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–∏ –Ω—É–∂–Ω–æ –ø–µ—Ä–µ–¥–∞—Ç—å delta_x –≤ API
            loadAnalysis();
        } else {
            alert('‚ùå –û—à–∏–±–∫–∞: ' + data.error);
        }
    } catch (e) {
        alert('‚ùå –û—à–∏–±–∫–∞: ' + e.message);
    } finally {
        btn.textContent = originalText;
        btn.disabled = false;
    }
}

// –ó–∞–∫—Ä—ã—Ç–∏–µ –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞ –ø–æ –∫–ª–∏–∫—É –≤–Ω–µ –µ–≥–æ
window.onclick = function(event) {
    const modal = document.getElementById('detailModal');
    if (event.target === modal) {
        closeModal();
    }
}
</script>

<style>
.spzr-dashboard .quality-row {
    border-left: 4px solid var(--success);
}
.spzr-dashboard .defect-row {
    border-left: 4px solid var(--danger);
    background-color: #FFF5F5;
}
.spzr-dashboard .stat-number {
    font-size: 2.5rem;
    font-weight: 700;
    margin: 0.5rem 0;
}
#detailModal {
    display: none;
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(0,0,0,0.5);
    z-index: 1000;
    justify-content: center;
    align-items: center;
}
</style>
{% endblock %}