{% extends "base.html" %}

{% block title %}–°–ü–ü–† - –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π –∞–Ω–∞–ª–∏–∑ –∫–∞—á–µ—Å—Ç–≤–∞{% endblock %}

{% block content %}
<div class="spzr-dashboard">
    <h1 class="page-title">üìä –°–∏—Å—Ç–µ–º–∞ –ø–æ–¥–¥–µ—Ä–∂–∫–∏ –ø—Ä–∏–Ω—è—Ç–∏—è —Ä–µ—à–µ–Ω–∏–π</h1>
    <p class="subtitle" style="color: var(--deep-ink); opacity: 0.7; margin-bottom: 1rem; font-size: 1.1rem;">
        –ü–æ—Ä–æ–≥–æ–≤—ã–π –º–µ—Ç–æ–¥ –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∏ –∫–∞—á–µ—Å—Ç–≤–∞ –ø—Ä–æ–¥—É–∫—Ü–∏–∏ (–ø–æ –º–µ—Ç–æ–¥–∏—á–∫–µ, —Å—Ç—Ä. 33-38)
    </p>
    
    <!-- –ü–æ—è—Å–Ω–µ–Ω–∏–µ -->
    <div style="background: var(--bone); border-radius: 12px; padding: 1.5rem; margin-bottom: 2rem; border-left: 4px solid var(--sand);">
        <h4 style="color: var(--deep-ink); margin-bottom: 0.75rem;">üìê –§–æ—Ä–º—É–ª—ã —Ä–∞—Å—á–µ—Ç–∞:</h4>
        <ul style="list-style: none; padding: 0; display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1rem;">
            <li><strong>Ch = N</strong> ‚Äî —Å–∏–≥–Ω–∞–ª –Ω–æ—Ä–º—ã (–∫–æ–ª–∏—á–µ—Å—Ç–≤–æ —Ö–∞—Ä–∞–∫—Ç–µ—Ä–∏—Å—Ç–∏–∫)</li>
            <li><strong>Co = Œ£ log‚ÇÇ(n·µ¢)</strong> ‚Äî —Å–∏–≥–Ω–∞–ª –æ—Ç–∫–ª–æ–Ω–µ–Ω–∏—è</li>
            <li><strong>Go = Co / Ch</strong> ‚Äî –æ—Ç–Ω–æ—à–µ–Ω–∏–µ –æ—Ç–∫–ª–æ–Ω–µ–Ω–∏–µ/–Ω–æ—Ä–º–∞</li>
            <li><strong>P = exp(-Go¬≤/2)</strong> ‚Äî –≤–µ—Ä–æ—è—Ç–Ω–æ—Å—Ç—å –ø—Ä–∞–≤–∏–ª—å–Ω–æ–π –∫–ª–∞—Å—Å–∏—Ñ–∏–∫–∞—Ü–∏–∏</li>
        </ul>
        <p style="margin-top: 1rem; padding-top: 1rem; border-top: 1px solid var(--border);">
            <strong>‚úÖ –ü—Ä–∞–≤–∏–ª–æ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏—è:</strong> 
            <span style="background: var(--success); color: white; padding: 0.2rem 0.8rem; border-radius: 20px;">P ‚â§ 0.5 ‚Üí –ö–ê–ß–ï–°–¢–í–ï–ù–ù–´–ô</span> 
            <span style="margin-left: 1rem; background: var(--danger); color: white; padding: 0.2rem 0.8rem; border-radius: 20px;">P > 0.5 ‚Üí –ë–†–ê–ö</span>
        </p>
    </div>
    
    <!-- –ü–∞–Ω–µ–ª—å —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è Œîx -->
    <div style="background: white; border-radius: 16px; padding: 1.5rem; margin-bottom: 2rem; border: 1px solid var(--border);">
        <div style="display: flex; flex-wrap: wrap; gap: 2rem; align-items: center; justify-content: space-between;">
            <div style="flex: 2; min-width: 300px;">
                <h4 style="color: var(--deep-ink); margin-bottom: 1rem;">‚öôÔ∏è –ù–∞—Å—Ç—Ä–æ–π–∫–∞ —á—É–≤—Å—Ç–≤–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏ (Œîx)</h4>
                <div style="display: flex; gap: 1rem; align-items: center; flex-wrap: wrap;">
                    <div style="flex: 3;">
                        <input type="range" id="deltaXSlider" min="0.1" max="5.0" step="0.1" value="1.0" style="width: 100%;" oninput="updateDeltaX()">
                    </div>
                    <div style="flex: 1; min-width: 100px;">
                        <input type="number" id="deltaXValue" value="1.0" step="0.1" min="0.1" max="5.0" class="form-control" onchange="updateDeltaXFromInput()">
                    </div>
                    <button onclick="applyDeltaX()" class="btn btn-primary">–ü—Ä–∏–º–µ–Ω–∏—Ç—å Œîx</button>
                </div>
                <p style="margin-top: 0.5rem; font-size: 0.9rem; opacity: 0.7;">
                    <strong>–¢–µ–∫—É—â–∏–π Œîx = <span id="currentDeltaX">1.0</span></strong> 
                    (–º–µ–Ω—å—à–µ –∑–Ω–∞—á–µ–Ω–∏–µ = –≤—ã—à–µ —á—É–≤—Å—Ç–≤–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å –∫ –æ—Ç–∫–ª–æ–Ω–µ–Ω–∏—è–º)
                </p>
            </div>
            <div style="flex: 1; text-align: center;">
                <div style="background: var(--bone); padding: 1rem; border-radius: 12px;">
                    <div style="font-size: 0.9rem; opacity: 0.7;">–í—Å–µ–≥–æ –ø–æ–∑–∏—Ü–∏–π</div>
                    <div id="totalCount" style="font-size: 2rem; font-weight: 700; color: var(--deep-ink);">0</div>
                </div>
            </div>
        </div>
        
        <!-- –ö–Ω–æ–ø–∫–∏ —ç–∫—Å–ø–æ—Ä—Ç–∞ -->
        <div style="display: flex; gap: 1rem; margin-top: 1rem; justify-content: flex-end;">
            <button onclick="exportSPZR('json')" class="btn btn-sm" style="background: var(--sand); color: var(--deep-ink);">
                üì• –°–∫–∞—á–∞—Ç—å JSON
            </button>
            <button onclick="exportSPZR('excel')" class="btn btn-sm btn-success">
                üì• –°–∫–∞—á–∞—Ç—å Excel
            </button>
        </div>
    </div>
    
    <!-- –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ -->
    <div class="stats-grid" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(180px, 1fr)); gap: 1.5rem; margin-bottom: 2rem;">
        <div class="stat-card" style="background: white; border-radius: 16px; padding: 1.5rem; text-align: center;">
            <div style="font-size: 0.9rem; opacity: 0.7;">–ö–∞—á–µ—Å—Ç–≤–µ–Ω–Ω—ã–µ (P ‚â§ 0.5)</div>
            <div id="qualityCount" class="stat-number" style="font-size: 2rem; font-weight: 700; color: var(--success);">0</div>
        </div>
        <div class="stat-card" style="background: white; border-radius: 16px; padding: 1.5rem; text-align: center;">
            <div style="font-size: 0.9rem; opacity: 0.7;">–ë—Ä–∞–∫ (P > 0.5)</div>
            <div id="defectCount" class="stat-number" style="font-size: 2rem; font-weight: 700; color: var(--danger);">0</div>
        </div>
        <div class="stat-card" style="background: white; border-radius: 16px; padding: 1.5rem; text-align: center;">
            <div style="font-size: 0.9rem; opacity: 0.7;">–°—Ä–µ–¥–Ω–∏–π Co/Ch</div>
            <div id="avgGo" class="stat-number" style="font-size: 2rem; font-weight: 700; color: var(--clay);">0</div>
        </div>
        <div class="stat-card" style="background: white; border-radius: 16px; padding: 1.5rem; text-align: center;">
            <div style="font-size: 0.9rem; opacity: 0.7;">–ü—Ä–æ—Ü–µ–Ω—Ç –±—Ä–∞–∫–∞</div>
            <div id="defectPercent" class="stat-number" style="font-size: 2rem; font-weight: 700; color: var(--clay);">0%</div>
        </div>
    </div>
    
    <!-- –î–∏–∞–≥—Ä–∞–º–º—ã -->
    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(400px, 1fr)); gap: 1.5rem; margin-bottom: 2rem;">
        <!-- –ö—Ä—É–≥–æ–≤–∞—è –¥–∏–∞–≥—Ä–∞–º–º–∞ (–≤–µ—Å–∞ —Ö–∞—Ä–∞–∫—Ç–µ—Ä–∏—Å—Ç–∏–∫) -->
        <div style="background: white; border-radius: 16px; padding: 1.5rem; border: 1px solid var(--border);">
            <h4 style="color: var(--deep-ink); margin-bottom: 1rem;">ü•ß –ó–Ω–∞—á–∏–º–æ—Å—Ç—å —Ö–∞—Ä–∞–∫—Ç–µ—Ä–∏—Å—Ç–∏–∫ (–≤–µ—Å–∞)</h4>
            <div style="height: 300px; position: relative;">
                <canvas id="weightPieChart"></canvas>
            </div>
        </div>
        
        <!-- –°—Ç–æ–ª–±—á–∞—Ç–∞—è –¥–∏–∞–≥—Ä–∞–º–º–∞ (–≥—Ä–∞–¥–∞—Ü–∏–∏ –¥–ª—è —Ç–µ–∫—É—â–µ–≥–æ Œîx) -->
        <div style="background: white; border-radius: 16px; padding: 1.5rem; border: 1px solid var(--border);">
            <h4 style="color: var(--deep-ink); margin-bottom: 1rem;">üìä –ì—Ä–∞–¥–∞—Ü–∏–∏ (n) –¥–ª—è Œîx = <span id="currentDeltaXChart">1.0</span></h4>
            <div style="height: 300px; position: relative;">
                <canvas id="gradationsBarChart"></canvas>
            </div>
            <p style="margin-top: 0.5rem; font-size: 0.8rem; opacity: 0.7; text-align: center;">
                –°—Ä–µ–¥–Ω–µ–µ –∑–Ω–∞—á–µ–Ω–∏–µ –ø–æ –≤—Å–µ–º –ø—Ä–æ–¥—É–∫—Ç–∞–º
            </p>
        </div>
    </div>
    
    <!-- –°—Ä–∞–≤–Ω–∏—Ç–µ–ª—å–Ω–∞—è –¥–∏–∞–≥—Ä–∞–º–º–∞ –¥–ª—è —Ä–∞–∑–Ω—ã—Ö Œîx -->
    <div style="background: white; border-radius: 16px; padding: 1.5rem; margin-bottom: 2rem; border: 1px solid var(--border);">
        <h4 style="color: var(--deep-ink); margin-bottom: 1rem;">üìä –°—Ä–∞–≤–Ω–µ–Ω–∏–µ –≥—Ä–∞–¥–∞—Ü–∏–π –ø—Ä–∏ —Ä–∞–∑–Ω—ã—Ö Œîx</h4>
        <div style="height: 400px; position: relative;">
            <canvas id="comparisonBarChart"></canvas>
        </div>
        <div style="display: flex; gap: 1rem; justify-content: center; margin-top: 1rem;">
            <button onclick="loadComparisonData()" class="btn btn-sm" style="background: var(--sand); color: var(--deep-ink);">
                üîÑ –û–±–Ω–æ–≤–∏—Ç—å —Å—Ä–∞–≤–Ω–µ–Ω–∏–µ
            </button>
        </div>
    </div>
    
    <!-- –§–∏–ª—å—Ç—Ä—ã –∏ –ø–æ–∏—Å–∫ -->
    <div style="display: flex; gap: 1rem; margin-bottom: 2rem; flex-wrap: wrap; justify-content: space-between; align-items: center;">
        <div style="display: flex; gap: 1rem;">
            <button onclick="loadAnalysis()" class="btn btn-primary">
                üîÑ –û–±–Ω–æ–≤–∏—Ç—å –∞–Ω–∞–ª–∏–∑
            </button>
            <button onclick="trainSystem()" class="btn" style="background: var(--sand); color: var(--deep-ink);">
                üß† –ü–æ–¥–æ–±—Ä–∞—Ç—å –æ–ø—Ç–∏–º–∞–ª—å–Ω—ã–π Œîx
            </button>
        </div>
        <div style="display: flex; gap: 1rem;">
            <select id="filterSelect" class="form-control" style="width: 150px;" onchange="filterResults()">
                <option value="all">–í—Å–µ –ø–æ–∑–∏—Ü–∏–∏</option>
                <option value="quality">–¢–æ–ª—å–∫–æ –∫–∞—á–µ—Å—Ç–≤–µ–Ω–Ω—ã–µ</option>
                <option value="defect">–¢–æ–ª—å–∫–æ –±—Ä–∞–∫</option>
            </select>
            <input type="text" id="searchInput" class="form-control" placeholder="üîç –ü–æ–∏—Å–∫..." style="width: 250px;" onkeyup="filterResults()">
        </div>
    </div>
    
    <!-- –ò–Ω–¥–∏–∫–∞—Ç–æ—Ä –∑–∞–≥—Ä—É–∑–∫–∏ -->
    <div id="loadingIndicator" style="display: none; text-align: center; padding: 3rem;">
        <div class="loading" style="display: inline-block; padding: 1rem 2rem; border-radius: 40px;">
            ‚è≥ –ê–Ω–∞–ª–∏–∑ –¥–∞–Ω–Ω—ã—Ö...
        </div>
    </div>
    
    <!-- –†–µ–∑—É–ª—å—Ç–∞—Ç—ã –∞–Ω–∞–ª–∏–∑–∞ -->
    <div id="resultsContainer" style="display: none;">
        <div class="spzr-results-table" style="background: white; border-radius: 16px; padding: 1.5rem; border: 1px solid var(--border);">
            <h3 style="color: var(--deep-ink); margin-bottom: 1.5rem;">üìã –†–µ–∑—É–ª—å—Ç–∞—Ç—ã –ø–æ—Ä–æ–≥–æ–≤–æ–π –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∏</h3>
            
            <div style="overflow-x: auto;">
                <table class="data-table" id="resultsTable">
                    <thead>
                        <tr>
                            <th>–ü–æ—Å—Ç–∞–≤—â–∏–∫</th>
                            <th>–ü—Ä–æ–¥—É–∫—Ü–∏—è</th>
                            <th>N</th>
                            <th title="–°—É–º–º–∞ log‚ÇÇ(n)">Co</th>
                            <th title="–û—Ç–Ω–æ—à–µ–Ω–∏–µ Co/Ch">Go</th>
                            <th title="–í–µ—Ä–æ—è—Ç–Ω–æ—Å—Ç—å P = exp(-Go¬≤/2)">P</th>
                            <th>–í–µ—Ä–¥–∏–∫—Ç</th>
                            <th>–î–µ–π—Å—Ç–≤–∏—è</th>
                        </tr>
                    </thead>
                    <tbody id="tableBody">
                        <!-- –î–∞–Ω–Ω—ã–µ –ø–æ–¥–≥—Ä—É–∑—è—Ç—Å—è —á–µ—Ä–µ–∑ JS -->
                    </tbody>
                </table>
            </div>
            
            <!-- –°–Ω–æ—Å–∫–∞ -->
            <div style="margin-top: 1.5rem; padding-top: 1rem; border-top: 1px solid var(--border); font-size: 0.9rem; color: var(--deep-ink); opacity: 0.7;">
                <p>üìå <strong>–ü–æ—è—Å–Ω–µ–Ω–∏—è:</strong> Ch = N, Co = Œ£ log‚ÇÇ(n·µ¢), Go = Co/Ch, P = exp(-Go¬≤/2). 
                <strong>‚úÖ –ö–∞—á–µ—Å—Ç–≤–µ–Ω–Ω—ã–π:</strong> P ‚â§ 0.5 | <strong>‚ùå –ë—Ä–∞–∫:</strong> P > 0.5</p>
            </div>
        </div>
    </div>
    
    <!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ —Å –¥–µ—Ç–∞–ª—è–º–∏ -->
    <div id="detailModal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 1000; justify-content: center; align-items: center;">
        <div style="background: white; border-radius: 16px; padding: 2rem; max-width: 900px; width: 90%; max-height: 80vh; overflow-y: auto;">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem;">
                <h3 style="color: var(--deep-ink);">–î–µ—Ç–∞–ª—å–Ω—ã–π –∞–Ω–∞–ª–∏–∑</h3>
                <button onclick="closeModal()" style="background: none; border: none; font-size: 1.5rem; cursor: pointer;">‚úï</button>
            </div>
            <div id="modalContent">
                <!-- –°–æ–¥–µ—Ä–∂–∏–º–æ–µ –ø–æ–¥–≥—Ä—É–∑–∏—Ç—Å—è –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–∏ -->
            </div>
        </div>
    </div>
</div>

<!-- –ü–æ–¥–∫–ª—é—á–∞–µ–º Chart.js -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<script>
let allResults = [];
let currentDelta = 1.0;
let weightChart = null;
let gradationsChart = null;
let comparisonChart = null;

// –ó–∞–≥—Ä—É–∑–∫–∞ –ø—Ä–∏ –æ—Ç–∫—Ä—ã—Ç–∏–∏ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
document.addEventListener('DOMContentLoaded', function() {
    loadAnalysis();
    loadWeightChart();
});

function updateDeltaX() {
    const slider = document.getElementById('deltaXSlider');
    const input = document.getElementById('deltaXValue');
    const span = document.getElementById('currentDeltaX');
    const chartSpan = document.getElementById('currentDeltaXChart');
    
    const val = parseFloat(slider.value).toFixed(1);
    input.value = val;
    span.textContent = val;
    if (chartSpan) chartSpan.textContent = val;
}

function updateDeltaXFromInput() {
    const slider = document.getElementById('deltaXSlider');
    const input = document.getElementById('deltaXValue');
    const span = document.getElementById('currentDeltaX');
    const chartSpan = document.getElementById('currentDeltaXChart');
    
    let val = parseFloat(input.value);
    if (isNaN(val) || val < 0.1) val = 0.1;
    if (val > 5.0) val = 5.0;
    
    input.value = val.toFixed(1);
    slider.value = val;
    span.textContent = val.toFixed(1);
    if (chartSpan) chartSpan.textContent = val.toFixed(1);
}

async function applyDeltaX() {
    currentDelta = parseFloat(document.getElementById('deltaXValue').value);
    await loadAnalysis();
    await loadComparisonData();
}

async function loadAnalysis() {
    document.getElementById('loadingIndicator').style.display = 'block';
    document.getElementById('resultsContainer').style.display = 'none';
    
    try {
        const response = await fetch(`/api/spzr/analyze-all?delta_x=${currentDelta}`);
        const data = await response.json();
        
        if (data.success) {
            allResults = data.results;
            
            // –û–±–Ω–æ–≤–ª—è–µ–º —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É
            document.getElementById('totalCount').textContent = data.total;
            document.getElementById('qualityCount').textContent = data.quality;
            document.getElementById('defectCount').textContent = data.defect;
            
            const avgGo = data.results.reduce((sum, r) => sum + r.metrics.Go, 0) / data.total;
            document.getElementById('avgGo').textContent = avgGo.toFixed(3);
            
            const percent = data.total > 0 ? Math.round(data.defect / data.total * 100) : 0;
            document.getElementById('defectPercent').textContent = percent + '%';
            
            // –û—Ç–æ–±—Ä–∞–∂–∞–µ–º —Ç–∞–±–ª–∏—Ü—É
            renderTable(allResults);
            document.getElementById('resultsContainer').style.display = 'block';
            
            // –û–±–Ω–æ–≤–ª—è–µ–º –¥–∏–∞–≥—Ä–∞–º–º—É –≥—Ä–∞–¥–∞—Ü–∏–π
            if (data.characteristic_stats) {
                updateGradationsChart(data.characteristic_stats);
            }
        } else {
            alert('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏: ' + data.error);
        }
    } catch (e) {
        alert('–û—à–∏–±–∫–∞: ' + e.message);
    } finally {
        document.getElementById('loadingIndicator').style.display = 'none';
    }
}

function renderTable(results) {
    const tbody = document.getElementById('tableBody');
    tbody.innerHTML = '';
    
    if (!results || results.length === 0) {
        tbody.innerHTML = '<tr><td colspan="8" style="text-align: center; padding: 2rem;">–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö</td></tr>';
        return;
    }
    
    results.forEach(item => {
        const metrics = item.metrics;
        const isQuality = metrics.P <= 0.5;
        
        const row = document.createElement('tr');
        row.innerHTML = `
            <td><strong>${item.supplier_name}</strong></td>
            <td>${item.product_name}</td>
            <td>${metrics.Ch}</td>
            <td>${metrics.Co.toFixed(3)}</td>
            <td>${metrics.Go.toFixed(3)}</td>
            <td>${metrics.P.toFixed(4)}</td>
            <td>
                <span style="display: inline-block; padding: 0.3rem 0.8rem; border-radius: 20px; background: ${isQuality ? 'var(--success)' : 'var(--danger)'}; color: white; font-size: 0.8rem;">
                    ${isQuality ? '‚úì –ö–ê–ß–ï–°–¢–í–ï–ù–ù–´–ô' : '‚úó –ë–†–ê–ö'}
                </span>
            </td>
            <td>
                <button onclick="showDetails(${item.product_id}, ${item.supplier_id})" class="btn btn-sm" style="background: var(--sand); color: var(--deep-ink);">
                    –î–µ—Ç–∞–ª–∏
                </button>
            </td>
        `;
        
        if (isQuality) {
            row.classList.add('quality-row');
        } else {
            row.classList.add('defect-row');
        }
        
        tbody.appendChild(row);
    });
}

async function loadWeightChart() {
    try {
        const response = await fetch('/api/spzr/characteristic-weights');
        const data = await response.json();
        
        if (data.success && data.characteristics) {
            const ctx = document.getElementById('weightPieChart').getContext('2d');
            
            if (weightChart) weightChart.destroy();
            
            weightChart = new Chart(ctx, {
                type: 'pie',
                data: {
                    labels: data.characteristics.map(c => c.name),
                    datasets: [{
                        data: data.characteristics.map(c => c.weight),
                        backgroundColor: [
                            'rgba(26, 42, 58, 0.8)',
                            'rgba(44, 62, 80, 0.8)',
                            'rgba(212, 178, 140, 0.8)',
                            'rgba(166, 123, 91, 0.8)',
                            'rgba(90, 122, 107, 0.8)',
                            'rgba(184, 92, 92, 0.8)',
                            'rgba(156, 156, 156, 0.8)'
                        ],
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'bottom',
                            labels: { font: { size: 10 } }
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    const label = context.label || '';
                                    const value = context.raw || 0;
                                    const total = context.dataset.data.reduce((a, b) => a + b, 0);
                                    const percentage = Math.round((value / total) * 100);
                                    return `${label}: ${value} (${percentage}%)`;
                                }
                            }
                        }
                    }
                }
            });
        }
    } catch (e) {
        console.error('Error loading weight chart:', e);
    }
}

function updateGradationsChart(stats) {
    if (!stats || stats.length === 0) return;
    
    const ctx = document.getElementById('gradationsBarChart').getContext('2d');
    
    if (gradationsChart) gradationsChart.destroy();
    
    gradationsChart = new Chart(ctx, {
        type: 'bar',
        data: {
            labels: stats.map(s => s.name),
            datasets: [{
                label: `–°—Ä–µ–¥–Ω–∏–µ –≥—Ä–∞–¥–∞—Ü–∏–∏ (n) –ø—Ä–∏ Œîx = ${currentDelta}`,
                data: stats.map(s => s.avg_gradations),
                backgroundColor: 'rgba(44, 62, 80, 0.7)',
                borderColor: 'rgba(26, 42, 58, 1)',
                borderWidth: 1
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            scales: {
                y: {
                    beginAtZero: true,
                    title: {
                        display: true,
                        text: '–ì—Ä–∞–¥–∞—Ü–∏–∏ n'
                    }
                }
            },
            plugins: {
                legend: { display: false }
            }
        }
    });
}

async function loadComparisonData() {
    try {
        const deltas = [0.2, 0.5, 1.0, 2.0, 5.0];
        const promises = deltas.map(d => 
            fetch(`/api/spzr/characteristic-stats?delta_x=${d}`).then(r => r.json())
        );
        
        const results = await Promise.all(promises);
        
        if (!results[0] || !results[0].success) return;
        
        const ctx = document.getElementById('comparisonBarChart').getContext('2d');
        const characteristics = results[0].stats.map(s => s.name);
        
        const datasets = deltas.map((d, index) => ({
            label: `Œîx = ${d}`,
            data: results[index].stats.map(s => s.avg_gradations),
            backgroundColor: `rgba(${44 + index * 20}, ${62 + index * 10}, ${80 - index * 10}, 0.7)`,
            borderColor: 'rgba(26, 42, 58, 1)',
            borderWidth: 1
        }));
        
        if (comparisonChart) comparisonChart.destroy();
        
        comparisonChart = new Chart(ctx, {
            type: 'bar',
            data: {
                labels: characteristics,
                datasets: datasets
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                scales: {
                    y: {
                        beginAtZero: true,
                        title: {
                            display: true,
                            text: '–°—Ä–µ–¥–Ω–∏–µ –≥—Ä–∞–¥–∞—Ü–∏–∏ n'
                        }
                    }
                },
                plugins: {
                    tooltip: { mode: 'index', intersect: false }
                }
            }
        });
        
    } catch (e) {
        console.error('Error loading comparison data:', e);
    }
}

function filterResults() {
    const filter = document.getElementById('filterSelect').value;
    const search = document.getElementById('searchInput').value.toLowerCase();
    
    let filtered = allResults;
    
    if (filter === 'quality') {
        filtered = filtered.filter(r => r.metrics.P <= 0.5);
    } else if (filter === 'defect') {
        filtered = filtered.filter(r => r.metrics.P > 0.5);
    }
    
    if (search) {
        filtered = filtered.filter(r => 
            r.supplier_name.toLowerCase().includes(search) ||
            r.product_name.toLowerCase().includes(search)
        );
    }
    
    renderTable(filtered);
}

async function showDetails(productId, supplierId) {
    try {
        const response = await fetch(`/api/spzr/product-detail?product_id=${productId}&supplier_id=${supplierId}&delta_x=${currentDelta}`);
        const data = await response.json();
        
        if (data.success) {
            displayModal(data);
        } else {
            alert('–û—à–∏–±–∫–∞: ' + data.error);
        }
    } catch (e) {
        alert('–û—à–∏–±–∫–∞: ' + e.message);
    }
}

function displayModal(data) {
    const product = data.product;
    const chars = data.characteristics;
    const metrics = data.metrics;
    const isQuality = metrics.P <= 0.5;
    
    // –ü–æ–¥—Å—á–∏—Ç—ã–≤–∞–µ–º –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –æ—Ç–∫–ª–æ–Ω–µ–Ω–∏–π
    const deviations = chars.filter(c => !c.in_norm).length;
    const totalChars = chars.length;
    
    let charsHtml = '';
    chars.forEach(c => {
        const inNorm = c.in_norm;
        charsHtml += `
            <tr ${!inNorm ? 'style="background: #FFF5F5;"' : ''}>
                <td><strong>${c.name}</strong></td>
                <td>${c.unit || '-'}</td>
                <td>${c.min} ‚Äî ${c.max}</td>
                <td style="font-weight: 600; ${!inNorm ? 'color: var(--danger);' : ''}">${c.real}</td>
                <td>${c.gradations}</td>
                <td>${c.log2.toFixed(3)}</td>
                <td>${c.weight}</td>
                <td style="text-align: center;">
                    ${inNorm 
                        ? '<span style="color: var(--success); font-weight: bold;">‚úì –≤ –Ω–æ—Ä–º–µ</span>' 
                        : '<span style="color: var(--danger); font-weight: bold;">‚úó –æ—Ç–∫–ª–æ–Ω–µ–Ω–∏–µ</span>'}
                </td>
            </tr>
        `;
    });
    
    const log2Sum = chars.reduce((sum, c) => sum + c.log2, 0).toFixed(3);
    
    // –ü–æ—è—Å–Ω–µ–Ω–∏–µ –¥–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
    let explanation = '';
    if (isQuality) {
        explanation = `
            <div style="background: #e8f3ed; padding: 1rem; border-radius: 8px; margin-bottom: 1rem;">
                <p><strong>‚úÖ –ü–æ—á–µ–º—É —Ç–æ–≤–∞—Ä –ö–ê–ß–ï–°–¢–í–ï–ù–ù–´–ô, —Ö–æ—Ç—è –µ—Å—Ç—å –æ—Ç–∫–ª–æ–Ω–µ–Ω–∏—è?</strong></p>
                <p>–ù–µ—Å–º–æ—Ç—Ä—è –Ω–∞ ${deviations} –æ—Ç–∫–ª–æ–Ω–µ–Ω–∏–π –∏–∑ ${totalChars}, —Å–∏—Å—Ç–µ–º–∞ —Å—á–∏—Ç–∞–µ—Ç —Ç–æ–≤–∞—Ä –∫–∞—á–µ—Å—Ç–≤–µ–Ω–Ω—ã–º, –ø–æ—Ç–æ–º—É —á—Ç–æ:</p>
                <ul>
                    <li>–û—Ç–∫–ª–æ–Ω–µ–Ω–∏—è –Ω–µ–∑–Ω–∞—á–∏—Ç–µ–ª—å–Ω—ã (–º–∞–ª—ã–µ –≥—Ä–∞–¥–∞—Ü–∏–∏ n)</li>
                    <li>–í–µ—Ä–æ—è—Ç–Ω–æ—Å—Ç—å P = ${metrics.P} ‚â§ 0.5 (–ø–æ –º–µ—Ç–æ–¥–∏—á–∫–µ —Å—Ç—Ä. 38)</li>
                    <li>–°–∏–≥–Ω–∞–ª –æ—Ç–∫–ª–æ–Ω–µ–Ω–∏—è Co = ${metrics.Co} –Ω–µ –ø—Ä–µ–≤—ã—à–∞–µ—Ç –ø–æ—Ä–æ–≥</li>
                </ul>
                <p><em>–ü–æ—Ä–æ–≥–æ–≤–æ–µ –ø—Ä–∞–≤–∏–ª–æ: P ‚â§ 0.5 ‚Üí –∫–∞—á–µ—Å—Ç–≤–µ–Ω–Ω—ã–π</em></p>
            </div>
        `;
    } else {
        explanation = `
            <div style="background: #fff2f0; padding: 1rem; border-radius: 8px; margin-bottom: 1rem;">
                <p><strong>‚ùå –ü–æ—á–µ–º—É —Ç–æ–≤–∞—Ä –ë–†–ê–ö, –µ—Å–ª–∏ –±–æ–ª—å—à–∏–Ω—Å—Ç–≤–æ —Ö–∞—Ä–∞–∫—Ç–µ—Ä–∏—Å—Ç–∏–∫ –≤ –Ω–æ—Ä–º–µ?</strong></p>
                <p>–•–æ—Ç—è —Ç–æ–ª—å–∫–æ ${deviations} –∏–∑ ${totalChars} —Ö–∞—Ä–∞–∫—Ç–µ—Ä–∏—Å—Ç–∏–∫ –∏–º–µ—é—Ç –æ—Ç–∫–ª–æ–Ω–µ–Ω–∏—è, —Å–∏—Å—Ç–µ–º–∞ —Å—á–∏—Ç–∞–µ—Ç —Ç–æ–≤–∞—Ä –±—Ä–∞–∫–æ–º, –ø–æ—Ç–æ–º—É —á—Ç–æ:</p>
                <ul>
                    <li>–û—Ç–∫–ª–æ–Ω–µ–Ω–∏—è –°–ò–õ–¨–ù–´–ï (–±–æ–ª—å—à–∏–µ –≥—Ä–∞–¥–∞—Ü–∏–∏ n)</li>
                    <li>–í–µ—Ä–æ—è—Ç–Ω–æ—Å—Ç—å P = ${metrics.P} > 0.5 (–ø–æ –º–µ—Ç–æ–¥–∏—á–∫–µ —Å—Ç—Ä. 38)</li>
                    <li>–°–∏–≥–Ω–∞–ª –æ—Ç–∫–ª–æ–Ω–µ–Ω–∏—è Co = ${metrics.Co} –ø—Ä–µ–≤—ã—à–∞–µ—Ç –ø–æ—Ä–æ–≥</li>
                </ul>
                <p><em>–ü–æ—Ä–æ–≥–æ–≤–æ–µ –ø—Ä–∞–≤–∏–ª–æ: P > 0.5 ‚Üí –±—Ä–∞–∫</em></p>
            </div>
        `;
    }
    
    const modalContent = document.getElementById('modalContent');
    modalContent.innerHTML = `
        <div style="margin-bottom: 2rem;">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
                <h4 style="color: var(--deep-ink);">${product.product_name}</h4>
                <span style="padding: 0.5rem 1.2rem; border-radius: 40px; background: ${isQuality ? 'var(--success)' : 'var(--danger)'}; color: white; font-weight: 600;">
                    ${isQuality ? '‚úì –ö–ê–ß–ï–°–¢–í–ï–ù–ù–´–ô' : '‚úó –ë–†–ê–ö'}
                </span>
            </div>
            <p><strong>–ü–æ—Å—Ç–∞–≤—â–∏–∫:</strong> ${product.supplier_name}</p>
            <p><strong>–ö–∞—Ç–µ–≥–æ—Ä–∏—è:</strong> ${product.category || '‚Äî'}</p>
            <p><strong>–û–ø–∏—Å–∞–Ω–∏–µ:</strong> ${product.description || '‚Äî'}</p>
        </div>
        
        ${explanation}
        
        <div style="background: var(--bone); padding: 1.5rem; border-radius: 12px; margin-bottom: 2rem;">
            <h4 style="margin-bottom: 1rem;">–†–∞—Å—á–µ—Ç –ø–æ–∫–∞–∑–∞—Ç–µ–ª–µ–π (Œîx = ${currentDelta}):</h4>
            <table style="width: 100%; border-collapse: collapse;">
                <tr>
                    <td style="padding: 0.5rem;"><strong>Ch = N</strong> = ${metrics.Ch}</td>
                    <td style="padding: 0.5rem;"><strong>Co = Œ£ log‚ÇÇ(n·µ¢)</strong> = ${log2Sum}</td>
                </tr>
                <tr>
                    <td style="padding: 0.5rem;"><strong>Go = Co / Ch</strong> = ${log2Sum} / ${metrics.Ch} = ${metrics.Go.toFixed(3)}</td>
                    <td style="padding: 0.5rem;"><strong>P = exp(-Go¬≤/2)</strong> = exp(-${(metrics.Go**2).toFixed(3)}/2) = ${metrics.P.toFixed(4)}</td>
                </tr>
            </table>
        </div>
        
        <h4 style="margin-bottom: 1rem;">–î–µ—Ç–∞–ª–∏–∑–∞—Ü–∏—è —Ö–∞—Ä–∞–∫—Ç–µ—Ä–∏—Å—Ç–∏–∫</h4>
        <div style="overflow-x: auto;">
            <table class="data-table">
                <thead>
                    <tr>
                        <th>–•–∞—Ä–∞–∫—Ç–µ—Ä–∏—Å—Ç–∏–∫–∞</th>
                        <th>–ï–¥.</th>
                        <th>–ù–æ—Ä–º–∞</th>
                        <th>–†–µ–∞–ª—å–Ω–æ–µ</th>
                        <th>n</th>
                        <th>log‚ÇÇ(n)</th>
                        <th>–í–µ—Å</th>
                        <th>–°—Ç–∞—Ç—É—Å</th>
                    </tr>
                </thead>
                <tbody>
                    ${charsHtml}
                </tbody>
            </table>
        </div>
        
        <div style="margin-top: 1.5rem; padding: 1rem; background: #f0f7ff; border-radius: 8px;">
            <p><strong>üìä –ê–Ω–∞–ª–∏–∑ –≥—Ä–∞–¥–∞—Ü–∏–π:</strong></p>
            <ul style="margin-left: 1.5rem;">
                <li>–°—É–º–º–∞ log‚ÇÇ(n) = ${log2Sum}</li>
                <li>–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ —Ö–∞—Ä–∞–∫—Ç–µ—Ä–∏—Å—Ç–∏–∫ N = ${metrics.Ch}</li>
                <li>–û—Ç–Ω–æ—à–µ–Ω–∏–µ Go = ${metrics.Go.toFixed(3)}</li>
                <li><strong>–í–µ—Ä–æ—è—Ç–Ω–æ—Å—Ç—å P = ${metrics.P.toFixed(4)}</strong></li>
                <li><strong>–ü—Ä–∞–≤–∏–ª–æ:</strong> P ${isQuality ? '‚â§ 0.5 ‚Üí –ö–ê–ß–ï–°–¢–í–ï–ù–ù–´–ô' : '> 0.5 ‚Üí –ë–†–ê–ö'}</li>
            </ul>
        </div>
    `;
    
    document.getElementById('detailModal').style.display = 'flex';
}

function closeModal() {
    document.getElementById('detailModal').style.display = 'none';
}

async function trainSystem() {
    if (!confirm('–ü–æ–¥–æ–±—Ä–∞—Ç—å –æ–ø—Ç–∏–º–∞–ª—å–Ω—ã–π —à–∞–≥ Œîx –¥–ª—è –≤—Å–µ–π –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö?')) return;
    
    const btn = event.target;
    const originalText = btn.textContent;
    btn.textContent = '‚è≥ –ü–æ–¥–±–æ—Ä...';
    btn.disabled = true;
    
    try {
        const response = await fetch('/api/spzr/train-all', {
            method: 'POST'
        });
        const data = await response.json();
        
        if (data.success) {
            alert(`‚úÖ –û–ø—Ç–∏–º–∞–ª—å–Ω—ã–π Œîx = ${data.best_delta}`);
            document.getElementById('deltaXSlider').value = data.best_delta;
            document.getElementById('deltaXValue').value = data.best_delta;
            updateDeltaX();
            await applyDeltaX();
        } else {
            alert('‚ùå –û—à–∏–±–∫–∞: ' + data.error);
        }
    } catch (e) {
        alert('‚ùå –û—à–∏–±–∫–∞: ' + e.message);
    } finally {
        btn.textContent = originalText;
        btn.disabled = false;
    }
}

async function exportSPZR(format) {
    const delta = currentDelta;
    window.open(`/api/spzr/export?delta_x=${delta}&format=${format}`, '_blank');
}

window.onclick = function(event) {
    const modal = document.getElementById('detailModal');
    if (event.target === modal) closeModal();
}
</script>

<style>
.spzr-dashboard .quality-row {
    border-left: 4px solid var(--success);
}
.spzr-dashboard .defect-row {
    border-left: 4px solid var(--danger);
    background-color: #FFF5F5;
}
.spzr-dashboard .stat-number {
    font-size: 2rem;
    font-weight: 700;
    margin: 0.5rem 0;
}
#detailModal {
    display: none;
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(0,0,0,0.5);
    z-index: 1000;
    justify-content: center;
    align-items: center;
}
canvas {
    max-height: 100%;
    max-width: 100%;
}
</style>
{% endblock %}