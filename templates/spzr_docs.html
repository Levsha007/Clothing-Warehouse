{% extends "base.html" %}

{% block title %}Документация СППР{% endblock %}

{% block content %}
<div class="docs-container" style="max-width: 1200px; margin: 0 auto;">
    <h1 class="page-title">Документация системы поддержки принятия решений</h1>
    <p style="color: var(--deep-ink); opacity: 0.7; margin-bottom: 2rem; font-size: 1.1rem;">
        Полное описание алгоритмов порогового метода диагностики качества продукции
    </p>

    <!-- Источник -->
    <div style="background: white; border-radius: 16px; padding: 2rem; border: 1px solid var(--border); margin-bottom: 2rem;">
        <h2 style="color: var(--deep-ink); margin-bottom: 1.5rem;">Источник</h2>
        
        <div style="background: var(--bone); padding: 1.5rem; border-radius: 12px;">
            <p><strong>Методические указания:</strong> "Создание информационной системы средствами Microsoft Access"</p>
            <p><strong>Раздел:</strong> 2.3. Создание информационной системы поддержки принятия решений (СППР)</p>
            <p><strong>Страницы:</strong> 33-38</p>
            <p><strong>Вариант:</strong> 19 — Склад одежды</p>
        </div>
    </div>

    <!-- 1. ГРАДАЦИИ -->
    <div style="background: white; border-radius: 16px; padding: 2rem; border: 1px solid var(--border); margin-bottom: 2rem;">
        <h2 style="color: var(--deep-ink); margin-bottom: 1.5rem;">1. Расчет градаций (стр. 35)</h2>
        
        <div style="background: #f8f9fa; padding: 1.5rem; border-radius: 12px; margin-bottom: 1.5rem;">
            <h3 style="color: var(--deep-ink); margin-bottom: 1rem;">Формула из методички:</h3>
            <div style="background: #1e2b3a; color: #f8f5f0; padding: 1.5rem; border-radius: 8px; font-family: 'Courier New', monospace; font-size: 1.1rem;">
                n = ⎧ 2, если значение характеристики в норме<br>
                &nbsp;&nbsp;&nbsp;&nbsp;⎨ (X - Xmin)/ΔX + 1, если значение характеристики > max значения нормы<br>
                &nbsp;&nbsp;&nbsp;&nbsp;⎩ (Xmax - X)/ΔX + 1, если значение характеристики < min значения нормы
            </div>
        </div>

        <div style="background: #e8f3ed; padding: 1.5rem; border-radius: 12px;">
            <h3 style="color: var(--deep-ink); margin-bottom: 1rem;">Пояснение переменных:</h3>
            <ul style="list-style: none; padding: 0;">
                <li style="margin-bottom: 0.75rem;"><strong>X</strong> — реальное значение характеристики</li>
                <li style="margin-bottom: 0.75rem;"><strong>Xmin</strong> — минимальное значение нормы</li>
                <li style="margin-bottom: 0.75rem;"><strong>Xmax</strong> — максимальное значение нормы</li>
                <li style="margin-bottom: 0.75rem;"><strong>Δx</strong> — шаг измерения (чувствительность системы)</li>
                <li style="margin-bottom: 0.75rem;"><strong>n</strong> — количество градаций (всегда ≥ 2)</li>
            </ul>
        </div>

        <div style="margin-top: 1.5rem; background: #f0f7ff; padding: 1.5rem; border-radius: 12px;">
            <h3 style="color: var(--deep-ink); margin-bottom: 1rem;">Реализация в коде:</h3>
            <p><strong>Файл:</strong> <code>main.py</code>, функция <code>analyze_all_quality()</code> (строки 250-270)</p>
            <pre style="background: #1e2b3a; color: #f8f5f0; padding: 1rem; border-radius: 8px; overflow-x: auto;">
if xmin <= x <= xmax:
    g = 2  # В норме
elif x > xmax:
    # Отклонение вверх: (X - Xmax)/Δx + 1
    g = int((x - xmax) / dx) + 1
else:  # x < xmin
    # Отклонение вниз: (Xmin - X)/Δx + 1
    g = int((xmin - x) / dx) + 1

g = max(2, min(g, 100))  # Ограничение разумными пределами
log2_g = math.log2(g)    # Двоичный логарифм</pre>
        </div>
    </div>

    <!-- 2. ПОКАЗАТЕЛИ Ch, Co, Go -->
    <div style="background: white; border-radius: 16px; padding: 2rem; border: 1px solid var(--border); margin-bottom: 2rem;">
        <h2 style="color: var(--deep-ink); margin-bottom: 1.5rem;">2. Показатели Ch, Co, Go (стр. 37)</h2>

        <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 1.5rem; margin-bottom: 1.5rem;">
            <div style="background: var(--bone); padding: 1.5rem; border-radius: 12px;">
                <h3 style="color: var(--deep-ink); margin-bottom: 0.75rem;">Ch</h3>
                <p style="font-size: 0.9rem; opacity: 0.7; margin-bottom: 0.5rem;">Сигнал нормы</p>
                <div style="background: #1e2b3a; color: #f8f5f0; padding: 0.75rem; border-radius: 6px; font-family: monospace; text-align: center; font-size: 1.2rem;">
                    Ch = N
                </div>
                <p style="margin-top: 0.75rem;">где <strong>N</strong> — количество характеристик (всегда 8)</p>
            </div>
            <div style="background: var(--bone); padding: 1.5rem; border-radius: 12px;">
                <h3 style="color: var(--deep-ink); margin-bottom: 0.75rem;">Co</h3>
                <p style="font-size: 0.9rem; opacity: 0.7; margin-bottom: 0.5rem;">Сигнал отклонения</p>
                <div style="background: #1e2b3a; color: #f8f5f0; padding: 0.75rem; border-radius: 6px; font-family: monospace; text-align: center; font-size: 1.2rem;">
                    Co = Σ log₂(nᵢ)
                </div>
                <p style="margin-top: 0.75rem;">сумма по 8 характеристикам</p>
            </div>
            <div style="background: var(--bone); padding: 1.5rem; border-radius: 12px;">
                <h3 style="color: var(--deep-ink); margin-bottom: 0.75rem;">Go</h3>
                <p style="font-size: 0.9rem; opacity: 0.7; margin-bottom: 0.5rem;">Отношение</p>
                <div style="background: #1e2b3a; color: #f8f5f0; padding: 0.75rem; border-radius: 6px; font-family: monospace; text-align: center; font-size: 1.2rem;">
                    Go = Co / Ch
                </div>
                <p style="margin-top: 0.75rem;">показывает степень отклонения</p>
            </div>
        </div>

        <div style="background: #f0f7ff; padding: 1.5rem; border-radius: 12px;">
            <h3 style="color: var(--deep-ink); margin-bottom: 1rem;">Реализация в коде:</h3>
            <p><strong>Файл:</strong> <code>main.py</code>, функция <code>analyze_all_quality()</code> (строки 280-290)</p>
            <pre style="background: #1e2b3a; color: #f8f5f0; padding: 1rem; border-radius: 8px;">
Ch = n
Co = sum_log2
Go = Co / Ch if Ch > 0 else 0</pre>
        </div>

        <div style="margin-top: 1.5rem; background: #fff2e0; padding: 1.5rem; border-radius: 12px;">
            <h3 style="color: var(--deep-ink); margin-bottom: 1rem;">Пример расчета для Δx=2.0:</h3>
            <p>Для товара ИП "Силуэт" - Джинсы мужские классические:</p>
            <ul>
                <li>7 характеристик в норме: log₂(2) = 1 каждая → сумма = 7</li>
                <li>1 характеристика с отклонением: n = 6 → log₂(6) = 2.585</li>
                <li>Ch = 8</li>
                <li>Co = 7 × 1 + 2.585 = 9.585</li>
                <li>Go = 9.585 / 8 = 1.198</li>
            </ul>
        </div>
    </div>

    <!-- 3. ВЕРОЯТНОСТЬ -->
    <div style="background: white; border-radius: 16px; padding: 2rem; border: 1px solid var(--border); margin-bottom: 2rem;">
        <h2 style="color: var(--deep-ink); margin-bottom: 1.5rem;">3. Вероятность правильной классификации (стр. 38)</h2>

        <div style="background: #f8f9fa; padding: 1.5rem; border-radius: 12px; margin-bottom: 1.5rem;">
            <h3 style="color: var(--deep-ink); margin-bottom: 1rem;">Формула из методички:</h3>
            <div style="background: #1e2b3a; color: #f8f5f0; padding: 1.5rem; border-radius: 8px; font-family: 'Courier New', monospace; font-size: 1.3rem; text-align: center;">
                P = e<sup>-ln2 / Go²</sup>
            </div>
            <p style="margin-top: 1rem; text-align: center;">где ln2 ≈ 0.693147</p>
        </div>

        <div style="background: #e8f3ed; padding: 1.5rem; border-radius: 12px;">
            <h3 style="color: var(--deep-ink); margin-bottom: 1rem;">Анализ формулы:</h3>
            <ul>
                <li>Чем больше Go (сильнее отклонения), тем меньше P</li>
                <li>Чем меньше P, тем выше уверенность в классификации</li>
                <li>При Go = 1: P = e<sup>-0.693</sup> = 0.5 (граничное значение)</li>
                <li>При Go = 1.2: P = e<sup>-0.693/1.44</sup> = e<sup>-0.481</sup> = 0.618</li>
                <li>При Go = 0.8: P = e<sup>-0.693/0.64</sup> = e<sup>-1.083</sup> = 0.339</li>
            </ul>
        </div>

        <div style="margin-top: 1.5rem; background: #f0f7ff; padding: 1.5rem; border-radius: 12px;">
            <h3 style="color: var(--deep-ink); margin-bottom: 1rem;">Реализация в коде:</h3>
            <p><strong>Файл:</strong> <code>main.py</code>, функция <code>analyze_all_quality()</code> (строки 290-300)</p>
            <pre style="background: #1e2b3a; color: #f8f5f0; padding: 1rem; border-radius: 8px; overflow-x: auto;">
if Go > 0:
    P = math.exp(-math.log(2) / (Go * Go))
else:
    # Если Go = 0 (все в норме) - вероятность минимальна
    P = math.exp(-math.log(2) / 0.0001)

P = round(P, 4)</pre>
        </div>
    </div>

    <!-- 4. ПОРОГОВОЕ ПРАВИЛО -->
    <div style="background: white; border-radius: 16px; padding: 2rem; border: 1px solid var(--border); margin-bottom: 2rem;">
        <h2 style="color: var(--deep-ink); margin-bottom: 1.5rem;">4. Пороговое решающее правило (стр. 38)</h2>

        <div style="background: #f8f9fa; padding: 1.5rem; border-radius: 12px; margin-bottom: 1.5rem;">
            <h3 style="color: var(--deep-ink); margin-bottom: 1rem;">Цитата из методички:</h3>
            <div style="background: #1e2b3a; color: #f8f5f0; padding: 1.5rem; border-radius: 8px; font-style: italic;">
                "За диапазон нормы принимается значение вероятности P от 0 до 0,5"
            </div>
        </div>

        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1.5rem; margin-bottom: 1.5rem;">
            <div style="background: #e8f3ed; padding: 1.5rem; border-radius: 12px; border-left: 4px solid var(--success);">
                <h3 style="color: var(--success); margin-bottom: 1rem;">Качественный товар</h3>
                <div style="background: #1e2b3a; color: #f8f5f0; padding: 1rem; border-radius: 8px; text-align: center; font-size: 1.2rem;">
                    P ≤ 0.5
                </div>
                <p style="margin-top: 1rem;">Система уверена в качестве продукции. Отклонения незначительны.</p>
            </div>
            <div style="background: #fee2e2; padding: 1.5rem; border-radius: 12px; border-left: 4px solid var(--danger);">
                <h3 style="color: var(--danger); margin-bottom: 1rem;">Брак</h3>
                <div style="background: #1e2b3a; color: #f8f5f0; padding: 1rem; border-radius: 8px; text-align: center; font-size: 1.2rem;">
                    P > 0.5
                </div>
                <p style="margin-top: 1rem;">Система обнаружила критические отклонения. Товар не соответствует нормам.</p>
            </div>
        </div>

        <div style="background: #f0f7ff; padding: 1.5rem; border-radius: 12px;">
            <h3 style="color: var(--deep-ink); margin-bottom: 1rem;">Реализация в коде:</h3>
            <p><strong>Файл:</strong> <code>main.py</code>, функция <code>analyze_all_quality()</code> (строки 300-310)</p>
            <pre style="background: #1e2b3a; color: #f8f5f0; padding: 1rem; border-radius: 8px;">
is_quality = P <= 0.5</pre>
        </div>
    </div>

    <!-- 5. ЗАВИСИМОСТЬ ОТ Δx -->
    <div style="background: white; border-radius: 16px; padding: 2rem; border: 1px solid var(--border); margin-bottom: 2rem;">
        <h2 style="color: var(--deep-ink); margin-bottom: 1.5rem;">5. Влияние шага измерения Δx</h2>

        <div style="background: #f8f9fa; padding: 1.5rem; border-radius: 12px; margin-bottom: 1.5rem;">
            <h3 style="color: var(--deep-ink); margin-bottom: 1rem;">Что такое Δx?</h3>
            <p><strong>Δx</strong> (шаг измерения) — минимальная единица шкалы, определяющая чувствительность системы.</p>
            <div style="background: #fff2e0; padding: 1rem; border-radius: 8px; margin-top: 1rem;">
                <p><strong>Важно:</strong> Δx стоит в знаменателе формулы градаций</p>
                <p style="font-family: monospace; font-size: 1.1rem;">n = (x - xmax)/Δx + 1  или  n = (xmin - x)/Δx + 1</p>
            </div>
        </div>

        <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 1.5rem; margin-bottom: 1.5rem;">
            <div style="background: #fee2e2; padding: 1.5rem; border-radius: 12px; border-left: 4px solid var(--danger);">
                <h3 style="color: var(--danger); margin-bottom: 1rem;">Маленький Δx (0.1)</h3>
                <p><strong>Очень высокая чувствительность:</strong></p>
                <ul style="margin-top: 0.5rem;">
                    <li>Δx маленький → знаменатель маленький</li>
                    <li>→ градации n очень большие</li>
                    <li>→ log₂(n) большие</li>
                    <li>→ Co большой (средний 1.722 × 8 = 13.78)</li>
                    <li>→ Go большой (1.722)</li>
                    <li>→ P = e^(-ln2/Go²) большое (>0.5)</li>
                    <li>→ P > 0.5 → много брака</li>
                </ul>
                <p style="margin-top: 1rem; font-weight: bold; color: var(--danger);">Результат: 37 брак, 11 качество (77% брака)</p>
            </div>
            <div style="background: #e8f3ed; padding: 1.5rem; border-radius: 12px; border-left: 4px solid var(--success);">
                <h3 style="color: var(--success); margin-bottom: 1rem;">Большой Δx (5.0)</h3>
                <p><strong>Низкая чувствительность:</strong></p>
                <ul style="margin-top: 0.5rem;">
                    <li>Δx большой → знаменатель большой</li>
                    <li>→ градации n маленькие (2-3)</li>
                    <li>→ log₂(n) маленькие (1-1.58)</li>
                    <li>→ Co маленький (средний 1.042 × 8 = 8.34)</li>
                    <li>→ Go маленький (1.042)</li>
                    <li>→ P = e^(-ln2/Go²) маленькое (≤0.5)</li>
                    <li>→ P ≤ 0.5 → мало брака</li>
                </ul>
                <p style="margin-top: 1rem; font-weight: bold; color: var(--success);">Результат: 12 брак, 36 качество (25% брака)</p>
            </div>
        </div>

        <div style="background: #fff2e0; padding: 1.5rem; border-radius: 12px;">
            <h3 style="color: var(--deep-ink); margin-bottom: 1rem;">Сравнение для разных Δx:</h3>
            <table style="width: 100%; border-collapse: collapse;">
                <tr>
                    <th style="padding: 0.75rem; border-bottom: 2px solid var(--border);">Δx</th>
                    <th style="padding: 0.75rem; border-bottom: 2px solid var(--border);">Средний Go</th>
                    <th style="padding: 0.75rem; border-bottom: 2px solid var(--border);">Качественные</th>
                    <th style="padding: 0.75rem; border-bottom: 2px solid var(--border);">Брак</th>
                    <th style="padding: 0.75rem; border-bottom: 2px solid var(--border);">% брака</th>
                </tr>
                <tr>
                    <td style="padding: 0.75rem; border-bottom: 1px solid var(--border);"><strong>0.1</strong></td>
                    <td style="padding: 0.75rem; border-bottom: 1px solid var(--border);">1.722</td>
                    <td style="padding: 0.75rem; border-bottom: 1px solid var(--border);">11</td>
                    <td style="padding: 0.75rem; border-bottom: 1px solid var(--border);">37</td>
                    <td style="padding: 0.75rem; border-bottom: 1px solid var(--border); color: var(--danger);"><strong>77%</strong></td>
                </tr>
                <tr>
                    <td style="padding: 0.75rem; border-bottom: 1px solid var(--border);"><strong>2.0</strong></td>
                    <td style="padding: 0.75rem; border-bottom: 1px solid var(--border);">1.315</td>
                    <td style="padding: 0.75rem; border-bottom: 1px solid var(--border);">25</td>
                    <td style="padding: 0.75rem; border-bottom: 1px solid var(--border);">23</td>
                    <td style="padding: 0.75rem; border-bottom: 1px solid var(--border);"><strong>48%</strong></td>
                </tr>
                <tr>
                    <td style="padding: 0.75rem;"><strong>5.0</strong></td>
                    <td style="padding: 0.75rem;">1.042</td>
                    <td style="padding: 0.75rem;">36</td>
                    <td style="padding: 0.75rem;">12</td>
                    <td style="padding: 0.75rem; color: var(--success);"><strong>25%</strong></td>
                </tr>
            </table>
            <p style="margin-top: 1.5rem; font-size: 1.2rem; text-align: center; background: #1e2b3a; color: #f8f5f0; padding: 1rem; border-radius: 8px;">
                <strong>Вывод:</strong> Чем меньше Δx (0.1) → тем больше брака (77%)<br>
                Чем больше Δx (5.0) → тем меньше брака (25%)
            </p>
        </div>
    </div>

    <!-- 6. КНОПКА ПОДБОРА ОПТИМАЛЬНОГО Δx -->
    <div style="background: white; border-radius: 16px; padding: 2rem; border: 1px solid var(--border); margin-bottom: 2rem;">
        <h2 style="color: var(--deep-ink); margin-bottom: 1.5rem;">6. Кнопка "Подобрать оптимальный Δx"</h2>

        <div style="background: #f0f7ff; padding: 1.5rem; border-radius: 12px; margin-bottom: 1.5rem;">
            <h3 style="color: var(--deep-ink); margin-bottom: 1rem;">Принцип работы:</h3>
            <p>Кнопка автоматически перебирает различные значения Δx и находит оптимальное, при котором количество качественных и бракованных товаров максимально сбалансировано.</p>
        </div>

        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1.5rem; margin-bottom: 1.5rem;">
            <div style="background: var(--bone); padding: 1.5rem; border-radius: 12px;">
                <h3 style="color: var(--deep-ink); margin-bottom: 1rem;">Алгоритм работы:</h3>
                <ol style="margin-left: 1.2rem;">
                    <li>Перебирает значения Δx: 0.1, 0.2, 0.5, 0.8, 1.0, 1.5, 2.0, 3.0, 5.0</li>
                    <li>Для каждого Δx вычисляет процент качественных товаров</li>
                    <li>Находит Δx, при котором процент качественных ближе всего к 50%</li>
                    <li>Устанавливает это значение как оптимальное</li>
                </ol>
            </div>
            <div style="background: var(--bone); padding: 1.5rem; border-radius: 12px;">
                <h3 style="color: var(--deep-ink); margin-bottom: 1rem;">Зачем это нужно:</h3>
                <p>Из методички (стр. 49-50):</p>
                <ul>
                    <li>"Обучение СППР... можно сделать вывод о том, правильно ли функционирует система"</li>
                    <li>"сдвинуть порог P" или "уменьшить шаг Δх"</li>
                    <li>Оптимальный Δx дает наиболее сбалансированную классификацию</li>
                </ul>
            </div>
        </div>

        <div style="background: #f0f7ff; padding: 1.5rem; border-radius: 12px;">
            <h3 style="color: var(--deep-ink); margin-bottom: 1rem;">Реализация в коде:</h3>
            <p><strong>Файл:</strong> <code>main.py</code>, функция <code>train_system_all()</code> (строки 420-500)</p>
            <pre style="background: #1e2b3a; color: #f8f5f0; padding: 1rem; border-radius: 8px; overflow-x: auto;">
deltas = [0.1, 0.2, 0.5, 0.8, 1.0, 1.5, 2.0, 3.0, 5.0]

for delta in deltas:
    # Рассчитываем процент качественных для этого Δx
    quality_percent = (quality_count / total * 100)
    results[delta] = quality_percent

# Находим Δx с минимальным отклонением от 50%
best_delta = min(deltas, key=lambda d: abs(results[d] - 50))</pre>
        </div>

        <div style="margin-top: 1.5rem; background: #fff2e0; padding: 1.5rem; border-radius: 12px;">
            <h3 style="color: var(--deep-ink); margin-bottom: 1rem;">Пример с текущими данными:</h3>
            <table style="width: 100%; border-collapse: collapse;">
                <tr>
                    <th style="padding: 0.75rem; border-bottom: 2px solid var(--border);">Δx</th>
                    <th style="padding: 0.75rem; border-bottom: 2px solid var(--border);">Качественные</th>
                    <th style="padding: 0.75rem; border-bottom: 2px solid var(--border);">Брак</th>
                    <th style="padding: 0.75rem; border-bottom: 2px solid var(--border);">% качественных</th>
                    <th style="padding: 0.75rem; border-bottom: 2px solid var(--border);">Отклонение от 50%</th>
                </tr>
                <tr>
                    <td style="padding: 0.75rem; border-bottom: 1px solid var(--border);">0.1</td>
                    <td style="padding: 0.75rem; border-bottom: 1px solid var(--border);">11</td>
                    <td style="padding: 0.75rem; border-bottom: 1px solid var(--border);">37</td>
                    <td style="padding: 0.75rem; border-bottom: 1px solid var(--border);">23%</td>
                    <td style="padding: 0.75rem; border-bottom: 1px solid var(--border);">27%</td>
                </tr>
                <tr>
                    <td style="padding: 0.75rem; border-bottom: 1px solid var(--border);">2.0</td>
                    <td style="padding: 0.75rem; border-bottom: 1px solid var(--border);">25</td>
                    <td style="padding: 0.75rem; border-bottom: 1px solid var(--border);">23</td>
                    <td style="padding: 0.75rem; border-bottom: 1px solid var(--border);">52%</td>
                    <td style="padding: 0.75rem; border-bottom: 1px solid var(--border); background: #e8f3ed;"><strong>2%</strong></td>
                </tr>
                <tr>
                    <td style="padding: 0.75rem;">5.0</td>
                    <td style="padding: 0.75rem;">36</td>
                    <td style="padding: 0.75rem;">12</td>
                    <td style="padding: 0.75rem;">75%</td>
                    <td style="padding: 0.75rem;">25%</td>
                </tr>
            </table>
            <p style="margin-top: 1rem; padding: 0.75rem; background: var(--success); color: white; border-radius: 8px; text-align: center;">
                <strong>Оптимальный Δx = 2.0</strong> (отклонение всего 2% от 50%)
            </p>
        </div>
    </div>

    <!-- 7. СТАТИСТИКА ПО ХАРАКТЕРИСТИКАМ -->
    <div style="background: white; border-radius: 16px; padding: 2rem; border: 1px solid var(--border); margin-bottom: 2rem;">
        <h2 style="color: var(--deep-ink); margin-bottom: 1.5rem;">7. Статистика по характеристикам</h2>

        <div style="background: #f0f7ff; padding: 1.5rem; border-radius: 12px; margin-bottom: 1.5rem;">
            <h3 style="color: var(--deep-ink); margin-bottom: 1rem;">Расчет средних градаций:</h3>
            <p><strong>Файл:</strong> <code>main.py</code>, функция <code>get_characteristic_stats()</code> (строки 160-200)</p>
            <pre style="background: #1e2b3a; color: #f8f5f0; padding: 1rem; border-radius: 8px; overflow-x: auto;">
# Для каждой характеристики собираем все градации
gradations = []
for v in ch_values:
    x = v['real_value']
    xmin = v['min_norm']
    xmax = v['max_norm']
    dx = delta_x
    
    if xmin <= x <= xmax:
        g = 2
    elif x > xmax:
        g = int((x - xmax) / dx) + 1
    else:
        g = int((xmin - x) / dx) + 1
    
    g = max(2, min(g, 100))
    gradations.append(g)

# Среднее значение
avg_g = sum(gradations) / len(gradations) if gradations else 0</pre>
        </div>

        <div style="background: #fff2e0; padding: 1.5rem; border-radius: 12px;">
            <h3 style="color: var(--deep-ink); margin-bottom: 1rem;">Данные для Δx=2.0:</h3>
            <table style="width: 100%; border-collapse: collapse;">
                <tr>
                    <th style="padding: 0.75rem; border-bottom: 2px solid var(--border);">Характеристика</th>
                    <th style="padding: 0.75rem; border-bottom: 2px solid var(--border);">Средние градации</th>
                    <th style="padding: 0.75rem; border-bottom: 2px solid var(--border);">Количество измерений</th>
                </tr>
                <tr><td>Состав ткани</td><td>2.5</td><td>48</td></tr>
                <tr><td>Плотность ткани</td><td>4.15</td><td>48</td></tr>
                <tr><td>Устойчивость окраски</td><td>2.0</td><td>48</td></tr>
                <tr><td>Усадка после стирки</td><td>2.08</td><td>48</td></tr>
                <tr><td>Прочность швов</td><td>2.25</td><td>48</td></tr>
                <tr><td>Соответствие размеру</td><td>2.58</td><td>48</td></tr>
                <tr><td>Качество упаковки</td><td>2.0</td><td>48</td></tr>
                <tr><td>Износостойкость</td><td>2.0</td><td>48</td></tr>
            </table>
        </div>
    </div>

    <!-- 8. ВЕСА ХАРАКТЕРИСТИК -->
    <div style="background: white; border-radius: 16px; padding: 2rem; border: 1px solid var(--border); margin-bottom: 2rem;">
        <h2 style="color: var(--deep-ink); margin-bottom: 1.5rem;">8. Веса характеристик (круговая диаграмма)</h2>

        <div style="background: #f0f7ff; padding: 1.5rem; border-radius: 12px; margin-bottom: 1.5rem;">
            <h3 style="color: var(--deep-ink); margin-bottom: 1rem;">Данные из БД:</h3>
            <pre style="background: #1e2b3a; color: #f8f5f0; padding: 1rem; border-radius: 8px;">
INSERT INTO characteristics (name, unit, delta_x_default, weight, description) VALUES
('Состав ткани', '%', 1.0, 25, 'Процентное содержание основного волокна'),
('Плотность ткани', 'г/м²', 10.0, 20, 'Вес квадратного метра ткани'),
('Устойчивость окраски', 'баллы', 0.5, 20, 'По 5-балльной шкале (1-5)'),
('Усадка после стирки', '%', 0.5, 15, 'Процент уменьшения размера после стирки'),
('Прочность швов', 'Н/см', 5.0, 20, 'Нагрузка до разрыва'),
('Соответствие размеру', 'мм', 2.0, 25, 'Отклонение от заявленного размера'),
('Качество упаковки', 'баллы', 0.5, 15, 'Внешний вид и целостность упаковки'),
('Износостойкость', 'баллы', 0.5, 20, 'Оценка износостойкости по 10-балльной шкале');</pre>
        </div>

        <div style="background: #fff2e0; padding: 1.5rem; border-radius: 12px;">
            <h3 style="color: var(--deep-ink); margin-bottom: 1rem;">Расчет процентов для круговой диаграммы:</h3>
            <p><strong>Файл:</strong> <code>spzr_dashboard.html</code>, функция <code>loadWeightChart()</code></p>
            <pre style="background: #1e2b3a; color: #f8f5f0; padding: 1rem; border-radius: 8px; overflow-x: auto;">
// Сумма всех весов = 25+20+20+15+20+25+15+20 = 160
// Процент = (weight / 160) * 100

tooltip: {
    callbacks: {
        label: function(context) {
            const value = context.raw;
            const total = context.dataset.data.reduce((a, b) => a + b, 0);
            const percentage = Math.round((value / total) * 100);
            return `${context.label}: ${value} (${percentage}%)`;
        }
    }
}</pre>
        </div>
    </div>

    <!-- 9. ПОЛНЫЙ АЛГОРИТМ -->
    <div style="background: white; border-radius: 16px; padding: 2rem; border: 1px solid var(--border); margin-bottom: 2rem;">
        <h2 style="color: var(--deep-ink); margin-bottom: 1.5rem;">9. Полный алгоритм работы СППР</h2>

        <div style="background: #1e2b3a; color: #f8f5f0; padding: 2rem; border-radius: 12px; font-family: monospace; line-height: 1.8;">
            <p>1. Для каждой характеристики товара:</p>
            <p style="margin-left: 2rem;">   если x в пределах [xmin, xmax]: n = 2</p>
            <p style="margin-left: 2rem;">   иначе если x > xmax: n = (x - xmax)/Δx + 1</p>
            <p style="margin-left: 2rem;">   иначе: n = (xmin - x)/Δx + 1</p>
            <p>2. Вычисляем log₂(n) для каждой характеристики</p>
            <p>3. Суммируем: Co = Σ log₂(n)</p>
            <p>4. Ch = количество характеристик (N)</p>
            <p>5. Go = Co / Ch</p>
            <p>6. P = exp(-ln2 / Go²)</p>
            <p>7. Если P ≤ 0.5 → товар качественный</p>
            <p>   Если P > 0.5 → товар брак</p>
        </div>
    </div>

    <!-- 10. ГДЕ ИСКАТЬ В КОДЕ -->
    <div style="background: white; border-radius: 16px; padding: 2rem; border: 1px solid var(--border);">
        <h2 style="color: var(--deep-ink); margin-bottom: 1.5rem;">10. Расположение в коде</h2>

        <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 1.5rem;">
            <div style="background: var(--bone); padding: 1.5rem; border-radius: 12px;">
                <h3 style="color: var(--deep-ink); margin-bottom: 1rem;">main.py</h3>
                <ul>
                    <li><code>analyze_all_quality()</code> — строки 200-350 (основные вычисления)</li>
                    <li><code>get_product_detail()</code> — строки 350-420 (детали товара)</li>
                    <li><code>train_system_all()</code> — строки 420-500 (обучение)</li>
                    <li><code>get_characteristic_stats()</code> — строки 160-200 (статистика)</li>
                </ul>
            </div>
            <div style="background: var(--bone); padding: 1.5rem; border-radius: 12px;">
                <h3 style="color: var(--deep-ink); margin-bottom: 1rem;">spzr_dashboard.html</h3>
                <ul>
                    <li><code>loadAnalysis()</code> — загрузка данных</li>
                    <li><code>renderTable()</code> — отрисовка таблицы с P ≤ 0.5</li>
                    <li><code>displayModal()</code> — детальный расчет</li>
                    <li><code>loadWeightChart()</code> — круговая диаграмма</li>
                    <li><code>updateGradationsChart()</code> — столбчатая диаграмма</li>
                </ul>
            </div>
            <div style="background: var(--bone); padding: 1.5rem; border-radius: 12px;">
                <h3 style="color: var(--deep-ink); margin-bottom: 1rem;">database.py</h3>
                <ul>
                    <li><code>execute_query()</code> — выполнение SQL</li>
                    <li><code>get_table_count()</code> — подсчет записей</li>
                    <li><code>get_table_data()</code> — получение данных</li>
                </ul>
            </div>
            <div style="background: var(--bone); padding: 1.5rem; border-radius: 12px;">
                <h3 style="color: var(--deep-ink); margin-bottom: 1rem;">init.sql</h3>
                <ul>
                    <li>Строки 250-300 — генерация данных с CASE</li>
                    <li>Строки 340-360 — статистика по браку</li>
                </ul>
            </div>
        </div>
    </div>
</div>

<style>
.docs-container pre {
    overflow-x: auto;
    white-space: pre-wrap;
    word-wrap: break-word;
}
.docs-container code {
    font-family: 'Courier New', monospace;
    background: #f0f0f0;
    padding: 0.2rem 0.4rem;
    border-radius: 4px;
    color: var(--deep-ink);
}
.docs-container table {
    width: 100%;
    border-collapse: collapse;
}
.docs-container th {
    text-align: left;
    font-weight: 600;
    color: var(--deep-ink);
    background: var(--bone);
}
.docs-container td {
    padding: 0.75rem;
    border-bottom: 1px solid var(--border);
}
.docs-container tr:hover {
    background: var(--bone);
}
</style>
{% endblock %}